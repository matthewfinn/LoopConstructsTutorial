(window.webpackJsonp=window.webpackJsonp||[]).push([[91,61,93],{121:function(e,t,n){"use strict";var o;n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return r})),function(e){e[e.Default=0]="Default",e[e.Search=1]="Search",e[e.Point=2]="Point",e[e.Paragraphs=3]="Paragraphs",e[e.Subsection=4]="Subsection",e[e.Section=5]="Section",e[e.BookElement=6]="BookElement",e[e.FreePreview=7]="FreePreview"}(o||(o={}));const r=new class{markParagraphsForUnscrambling(e){e.forEach(e=>{e.find(".scrambled-notifier").remove(),e.addClass("unscrambling"),e.removeClass("unscramble-target")})}adaptReadableTextContentForUnscrambling(e){e.forEach(e=>{if(e.attr("data-original-html",e.html()),1===e.children().length&&1===e.children("p").length){const t=e.children("p");t.html(`<div class="scrambled-content-container">${t.html()}</div>\n                     <div class="unscrambled-content-container"></div>`)}else e.html(`<div class="scrambled-content-container">${e.html()}</div>\n                     <div class="unscrambled-content-container"></div>`)})}resetUnscrambledElements(e){e.forEach(e=>{e.html(e.attr("data-original-html")),e.attr("data-original-html",""),e.removeClass("unscrambling")})}getDataFromPointingLink(e,t,n){if(!e||!t||!n||n.length<2)return null;const o={bookShortName:e.shortName,bookElementShortName:t.shortName,paragraphId:void 0,paragraphFingerprint:void 0,pointingLinkId:void 0,paragraphsToUnlock:void 0,startParagraphId:void 0,endParagraphId:void 0,meapVersion:t.meapVersion||0,isUserEditorLink:!1};if(2==n.length?(o.paragraphId=n[0],o.paragraphFingerprint=n[1],o.startParagraphId=parseInt(n[0]),o.endParagraphId=parseInt(n[0])):(o.pointingLinkId=n[0],o.startParagraphId=parseInt(n[1]),o.endParagraphId=parseInt(n[2]),o.isUserEditorLink="1"===n[3]),Number.isNaN(o.startParagraphId)||Number.isNaN(o.endParagraphId))return null;if(o.startParagraphId>o.endParagraphId){let e=o.startParagraphId;o.startParagraphId=o.endParagraphId,o.endParagraphId=e}return o}isEncompassingWholeContent(e,t){if("1"!=e)return!1;try{const e=document.querySelector(`[refid="${t}"]`),n=document.querySelector(`[refid="${+t+1}"]`);return null!=e&&null==n}catch(e){return!1}}replaceEncryptedContent(e,t){return t&&t.forEach(t=>{const n=e.find("[refid='"+t.paragraphID+"']");n.is(".scrambled")&&n.html(t.content).removeClass("scrambled").addClass("unscrambled")}),e.html()}}},169:function(e,t,n){"use strict";var o=n(1),r=n(14),a=n(29),i=n(8),s=n(6),l=n(0),u=n(28);t.a=new class{getTokenCountInfo(e=!1){return e||null==this.currentTokenCountInfo?e||null==this.currentTokenCountInfoPromise?this.currentTokenCountInfoPromise=new Promise((t,n)=>{s.a.isLoggedIn(e).then(e=>{e.loggedIn&&e.userDetails.tokenInfo?(this.currentTokenCountInfo=e.userDetails.tokenInfo,t(e.userDetails.tokenInfo)):(this.currentTokenCountInfoPromise=null,n("No token count info"))}).catch(e=>n(e))}):this.currentTokenCountInfoPromise:Promise.resolve(this.currentTokenCountInfo)}setTokenCountInfo(e){this.currentTokenCountInfo=e,r.a.setTokenInfo(e)}getTokenLedgerItems(e=!1){return l.b.isApp()&&!l.b.isConnected()?Promise.resolve([]):s.a.isCurrentlyLoggedIn()?e&&this.lastTokenLedger?Promise.resolve(this.lastTokenLedger):new Promise((e,t)=>{o.a.getFromOurBackend(o.a.getAbsoluteUrl("api/token/getTokenLedger"),t=>{const n=t.map(e=>{return{date:i.a.getDateFromString(e.date),quantity:e.quantity,description:e.description,notes:e.notes,link:u.a.adjustBookLink(e.link),isFreeTokensRedemption:"COMPED"==e.type}});this.lastTokenLedger=n,e(n)},e=>{t("Error getting token ledger")})}):Promise.resolve([])}getTokenCashoutInfo(){return new Promise((e,t)=>{o.a.getFromOurBackend(o.a.getAbsoluteUrl("api/token/getCashoutInfo"),t=>{t&&t.tokenCount&&(this.setTokenCountInfo(t.tokenCount),a.a.refreshTokenStateInToolbar(t.tokenCount)),e(t)},e=>t("Error getting token ledger"))})}cashout(){return new Promise((e,t)=>{o.a.getFromOurBackend(o.a.getAbsoluteUrl("api/token/cashout"),t=>{t&&t.tokenCount&&(this.setTokenCountInfo(t.tokenCount),a.a.refreshTokenStateInToolbar(t.tokenCount)),e(t)},e=>t("Error performing token cashout"))})}}},255:function(e,t,n){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(t,"__esModule",{value:!0});var r=o(n(98)),a=n(87),i=o(a),s=o(n(332)),l=o(n(256));function u(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function m(e,t){return(m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],o=!0,r=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(o=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);o=!0);}catch(e){r=!0,a=e}finally{try{o||null==s.return||s.return()}finally{if(r)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var g=function(e,t){var n=t.decimal,o=t.decimals,r=t.duration,a=t.easingFn,i=t.end,s=t.formattingFn,u=t.prefix,c=t.separator,d=t.start,h=t.suffix,m=t.useEasing;return new l(e,d,i,o,r,{decimal:n,easingFn:a,formattingFn:s,separator:c,prefix:u,suffix:h,useEasing:m,useGrouping:!!c})},k=function(e){function t(){var e,n,o,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var a=arguments.length,l=new Array(a),u=0;u<a;u++)l[u]=arguments[u];return o=this,r=(e=h(t)).call.apply(e,[this].concat(l)),n=!r||"object"!=typeof r&&"function"!=typeof r?p(o):r,c(p(n),"createInstance",(function(){return"function"==typeof n.props.children&&s(n.containerRef.current&&(n.containerRef.current instanceof HTMLElement||n.containerRef.current instanceof SVGTextElement||n.containerRef.current instanceof SVGTSpanElement),'Couldn\'t find attached element to hook the CountUp instance into! Try to attach "containerRef" from the render prop to a an HTMLElement, eg. <span ref={containerRef} />.'),g(n.containerRef.current,n.props)})),c(p(n),"pauseResume",(function(){var e=p(n),t=e.reset,o=e.restart,r=e.update,a=n.props.onPauseResume;n.instance.pauseResume(),a({reset:t,start:o,update:r})})),c(p(n),"reset",(function(){var e=p(n),t=e.pauseResume,o=e.restart,r=e.update,a=n.props.onReset;n.instance.reset(),a({pauseResume:t,start:o,update:r})})),c(p(n),"restart",(function(){n.reset(),n.start()})),c(p(n),"start",(function(){var e=p(n),t=e.pauseResume,o=e.reset,r=e.restart,a=e.update,i=n.props,s=i.delay,l=i.onEnd,u=i.onStart,c=function(){return n.instance.start((function(){return l({pauseResume:t,reset:o,start:r,update:a})}))};s>0?n.timeoutId=setTimeout(c,1e3*s):c(),u({pauseResume:t,reset:o,update:a})})),c(p(n),"update",(function(e){var t=p(n),o=t.pauseResume,r=t.reset,a=t.restart,i=n.props.onUpdate;n.instance.update(e),i({pauseResume:o,reset:r,start:a})})),c(p(n),"containerRef",i.createRef()),n}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(t,e),n=t,(o=[{key:"componentDidMount",value:function(){var e=this.props,t=e.children,n=e.delay;this.instance=this.createInstance(),"function"==typeof t&&0!==n||this.start()}},{key:"shouldComponentUpdate",value:function(e){var t=this.props,n=t.end,o=t.start,r=t.suffix,a=t.prefix,i=t.redraw,s=t.duration,l=t.separator,u=t.decimals,c=t.decimal;return s!==e.duration||n!==e.end||o!==e.start||r!==e.suffix||a!==e.prefix||l!==e.separator||u!==e.decimals||c!==e.decimal||i}},{key:"componentDidUpdate",value:function(e){var t=this.props,n=t.end,o=t.start,r=t.suffix,a=t.prefix,i=t.duration,s=t.separator,l=t.decimals,u=t.decimal,c=t.preserveValue;i===e.duration&&o===e.start&&r===e.suffix&&a===e.prefix&&s===e.separator&&l===e.decimals&&u===e.decimal||(this.instance.reset(),this.instance=this.createInstance(),this.start()),n!==e.end&&(c||this.instance.reset(),this.instance.update(n))}},{key:"componentWillUnmount",value:function(){this.timeoutId&&clearTimeout(this.timeoutId),this.instance.reset()}},{key:"render",value:function(){var e=this.props,t=e.children,n=e.className,o=e.style,r=this.containerRef,a=this.pauseResume,s=this.reset,l=this.restart,u=this.update;return"function"==typeof t?t({countUpRef:r,pauseResume:a,reset:s,start:l,update:u}):i.createElement("span",{className:n,ref:r,style:o})}}])&&u(n.prototype,o),r&&u(n,r),t}(a.Component);c(k,"propTypes",{decimal:r.string,decimals:r.number,delay:r.number,easingFn:r.func,end:r.number.isRequired,formattingFn:r.func,onEnd:r.func,onStart:r.func,prefix:r.string,redraw:r.bool,separator:r.string,start:r.number,startOnMount:r.bool,suffix:r.string,style:r.object,useEasing:r.bool,preserveValue:r.bool}),c(k,"defaultProps",{decimal:".",decimals:0,delay:null,duration:null,easingFn:null,formattingFn:null,onEnd:function(){},onPauseResume:function(){},onReset:function(){},onStart:function(){},onUpdate:function(){},prefix:"",redraw:!1,separator:"",start:0,startOnMount:!0,suffix:"",style:void 0,useEasing:!0,preserveValue:!1});var b={innerHTML:null};t.default=k,t.useCountUp=function(e){var t=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},k.defaultProps,{},e),n=t.start,o=t.formattingFn,r=f(a.useState("function"==typeof o?o(n):n),2),i=r[0],s=r[1],l=a.useRef(null),u=function(){var e=l.current;if(null!==e)return e;var n=function(){var e=g(b,t),n=e.options.formattingFn;return e.options.formattingFn=function(){var e=n.apply(void 0,arguments);s(e)},e}();return l.current=n,n},h=function(){var e=t.onReset;u().reset(),e({pauseResume:p,start:m,update:T})},m=function e(){var n=t.onStart,o=t.onEnd;u().reset(),u().start((function(){o({pauseResume:p,reset:h,start:e,update:T})})),n({pauseResume:p,reset:h,update:T})},p=function(){var e=t.onPauseResume;u().pauseResume(),e({reset:h,start:m,update:T})},T=function(e){var n=t.onUpdate;u().update(e),n({pauseResume:p,reset:h,start:m})};return a.useEffect((function(){var e=t.delay,n=t.onStart,o=t.onEnd;if(t.startOnMount)var r=setTimeout((function(){n({pauseResume:p,reset:h,update:T}),u().start((function(){clearTimeout(r),o({pauseResume:p,reset:h,start:m,update:T})}))}),1e3*e);return h}),[]),{countUp:i,start:m,pauseResume:p,reset:h,update:T}}},256:function(e,t,n){var o,r;void 0===(r="function"==typeof(o=function(e,t,n){return function(e,t,n,o,r,a){function i(e){return"number"==typeof e&&!isNaN(e)}var s=this;if(s.version=function(){return"1.9.3"},s.options={useEasing:!0,useGrouping:!0,separator:",",decimal:".",easingFn:function(e,t,n,o){return n*(1-Math.pow(2,-10*e/o))*1024/1023+t},formattingFn:function(e){var t,n,o,r,a,i,l=e<0;if(e=Math.abs(e).toFixed(s.decimals),n=(t=(e+="").split("."))[0],o=t.length>1?s.options.decimal+t[1]:"",s.options.useGrouping){for(r="",a=0,i=n.length;a<i;++a)0!==a&&a%3==0&&(r=s.options.separator+r),r=n[i-a-1]+r;n=r}return s.options.numerals.length&&(n=n.replace(/[0-9]/g,(function(e){return s.options.numerals[+e]})),o=o.replace(/[0-9]/g,(function(e){return s.options.numerals[+e]}))),(l?"-":"")+s.options.prefix+n+o+s.options.suffix},prefix:"",suffix:"",numerals:[]},a&&"object"==typeof a)for(var l in s.options)a.hasOwnProperty(l)&&null!==a[l]&&(s.options[l]=a[l]);""===s.options.separator?s.options.useGrouping=!1:s.options.separator=""+s.options.separator;for(var u=0,c=["webkit","moz","ms","o"],d=0;d<c.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=window[c[d]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[c[d]+"CancelAnimationFrame"]||window[c[d]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,t){var n=(new Date).getTime(),o=Math.max(0,16-(n-u)),r=window.setTimeout((function(){e(n+o)}),o);return u=n+o,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),s.initialize=function(){return!(!s.initialized&&(s.error="",s.d="string"==typeof e?document.getElementById(e):e,s.d?(s.startVal=Number(t),s.endVal=Number(n),i(s.startVal)&&i(s.endVal)?(s.decimals=Math.max(0,o||0),s.dec=Math.pow(10,s.decimals),s.duration=1e3*Number(r)||2e3,s.countDown=s.startVal>s.endVal,s.frameVal=s.startVal,s.initialized=!0,0):(s.error="[CountUp] startVal ("+t+") or endVal ("+n+") is not a number",1)):(s.error="[CountUp] target is null or undefined",1)))},s.printValue=function(e){var t=s.options.formattingFn(e);"INPUT"===s.d.tagName?this.d.value=t:"text"===s.d.tagName||"tspan"===s.d.tagName?this.d.textContent=t:this.d.innerHTML=t},s.count=function(e){s.startTime||(s.startTime=e),s.timestamp=e;var t=e-s.startTime;s.remaining=s.duration-t,s.options.useEasing?s.countDown?s.frameVal=s.startVal-s.options.easingFn(t,0,s.startVal-s.endVal,s.duration):s.frameVal=s.options.easingFn(t,s.startVal,s.endVal-s.startVal,s.duration):s.countDown?s.frameVal=s.startVal-(s.startVal-s.endVal)*(t/s.duration):s.frameVal=s.startVal+(s.endVal-s.startVal)*(t/s.duration),s.countDown?s.frameVal=s.frameVal<s.endVal?s.endVal:s.frameVal:s.frameVal=s.frameVal>s.endVal?s.endVal:s.frameVal,s.frameVal=Math.round(s.frameVal*s.dec)/s.dec,s.printValue(s.frameVal),t<s.duration?s.rAF=requestAnimationFrame(s.count):s.callback&&s.callback()},s.start=function(e){s.initialize()&&(s.callback=e,s.rAF=requestAnimationFrame(s.count))},s.pauseResume=function(){s.paused?(s.paused=!1,delete s.startTime,s.duration=s.remaining,s.startVal=s.frameVal,requestAnimationFrame(s.count)):(s.paused=!0,cancelAnimationFrame(s.rAF))},s.reset=function(){s.paused=!1,delete s.startTime,s.initialized=!1,s.initialize()&&(cancelAnimationFrame(s.rAF),s.printValue(s.startVal))},s.update=function(e){if(s.initialize()){if(!i(e=Number(e)))return void(s.error="[CountUp] update() - new endVal is not a number: "+e);s.error="",e!==s.frameVal&&(cancelAnimationFrame(s.rAF),s.paused=!1,delete s.startTime,s.startVal=s.frameVal,s.endVal=e,s.countDown=s.startVal>s.endVal,s.rAF=requestAnimationFrame(s.count))}},s.initialize()&&s.printValue(s.startVal)}})?o.call(t,n,t,e):o)||(e.exports=r)},333:function(e,t,n){"use strict";n.r(t),n.d(t,"TokenModalClass",(function(){return b})),n.d(t,"TokenModal",(function(){return T}));var o=n(87),r=n(97),a=n(334),i=n(399),s=n(578),l=n(106),u=n(400),c=n(169),d=n(4),h=n(9),m=n(13),p=n(1),f=n(25),g=n(29),k=n(6);class b{constructor(){this.handleResizeStop=this.handleResizeStop.bind(this),this.$tokenHeaderButton=$(".main-token-status-container"),this.initialStep=void 0,$(document).on("click",".main-token-status-container",()=>{this.$tokenHeaderButton.is(".selected")?this.render(!1):this.render(!0)}).on("click",".token-notifier-container .sign-in-button",()=>this.render(!1)).on("slideMenuOpened modalOpening searchOpen",()=>this.render(!1)).on("click",".token-ledger-table-container a",()=>this.render(!1)).on("withinChapterLinkScroll",()=>this.render(!1)).on("landing-page-appropriate-releases-initialized",()=>{void 0!==this.initialStep&&(this.render(!0),this.initialStep=void 0)}),$(window).on("resizestop",this.handleResizeStop),f.a.getTokenProductOffering().then(e=>{this.tokenProductOfferingPrice=e.price||.01}).catch(e=>{console.log("Error when getting token product offering price"),this.tokenProductOfferingPrice=.01})}initialize(){this.initialStep=this.getInitialTokenModalState()}getInitialTokenModalState(){const e=document.location.hash||document.location.pathname;return e.indexOf("token-ledger")>=0?s.a.ledger:e.indexOf("token-modal")>=0?s.a.showingTokenInfo:e.indexOf("token-cashout")>=0?s.a.cashout:e.indexOf("get-tokens")>=0?s.a.purchasing:void 0}clean(){r.unmountComponentAtNode(document.getElementById("full-screen-modal")),this.$tokenHeaderButton.removeClass("selected")}handleResizeStop(){this.positionModal(),setTimeout(()=>this.positionModal(),100)}positionModal(){if(!$(document.body).is(".ReactModal__Body--open"))return;const e=$(".ReactModal__Overlay");if(e.find(".shopping-cart-modal").length>0)return;const t=h.a.getNavbarHeightInPx();e.css("top",t)}show(){this.render(!0),this.positionModal()}hide(){this.render(!1)}render(e){this.$tokenHeaderButton.toggleClass("selected",e),k.a.isCurrentlyLoggedIn()?r.render(o.createElement(s.b,{isShown:e,onClose:()=>this.render(!1),livebookBaseLink:p.a.getLivebookBaseUrl(),livevideoBaseLink:p.a.getLivevideoBaseUrl(),initialStep:this.initialStep,tokenPrice:this.tokenProductOfferingPrice||.01,topOffset:h.a.getNavbarHeightInPx(),onCashout:()=>new Promise((e,t)=>{c.a.cashout().then(n=>{n&&!1===n.success&&n.reason?t(n.reason):e(!0)}).catch(e=>{t("Error when performing cashout. Try later or contact our support: support@manning.com")})}),onAddTokensToCart:e=>this.buyTokens(e),getCashoutPaymentTypes:()=>new Promise((e,t)=>{c.a.getTokenCashoutInfo().then(t=>{e(t&&t.paymentsInfo)}).catch(e=>{t("Error when ")})}),getTokenLedgerItems:()=>c.a.getTokenLedgerItems(),getTokenState:()=>new Promise((t,n)=>{c.a.getTokenCountInfo(e).then(e=>{c.a.setTokenCountInfo(e),g.a.refreshTokenStateInToolbar(e),t(e)}).catch(e=>{n(e)})})}),document.getElementById("full-screen-modal")):r.render(o.createElement(a.a,{isShown:e,title:"Tokens",onClose:()=>this.render(!1),topOffset:h.a.getNavbarHeightInPx()},o.createElement("p",null,"Tokens can be used to unlock parts of books, from sub-sections to chapters.",o.createElement("br",null),"Any dollar amount spent unlocking content will be deducted from the final book price.",o.createElement("br",null),"You can cash out any time, reverting tokens back to dollars."),o.createElement("p",null,o.createElement("a",{className:"sign-in-button micropurchase-sign-in",href:"javascript:void(0)"},"sign in")," and get 500 tokens for FREE!")),document.getElementById("full-screen-modal"))}renderOutOfTokensNotifier(e,t=!0){r.render(o.createElement(i.a,{isShown:t,topOffset:h.a.getNavbarHeightInPx(),showBuyTokensButton:!0,showCartButton:!0,isProductAlreadyInCart:f.a.isEbookInShoppingCart(e),productType:"book",productTitle:m.a.cleanBookTitle(e.title),isMeap:e.isMeap,onRequestBuyTokens:()=>{this.renderOutOfTokensNotifier(e,!1),setTimeout(()=>{this.initialStep=s.a.purchasing,this.render(!0)},200)},onRequestCart:()=>{f.a.isEbookInShoppingCart(e)||f.a.requestAddBookToCart(e),this.renderOutOfTokensNotifier(e,!1)},onClose:()=>this.renderOutOfTokensNotifier(e,!1)}),document.getElementById("full-screen-modal"))}renderOutOfParagraphByParagraphUnlocks(e,t){r.render(o.createElement(a.a,{isShown:e,title:"Out of individual paragraph tokens",onClose:()=>this.renderOutOfParagraphByParagraphUnlocks(!1),topOffset:h.a.getNavbarHeightInPx()},o.createElement("p",null,t)),document.getElementById("full-screen-modal"))}renderLicenceCreatedModal(e=!0){r.render(o.createElement(a.a,{isShown:e,title:"you've spent enough tokens on this book to unlock the rest of it for free",theme:l.a.green,topOffset:h.a.getNavbarHeightInPx(),onClose:()=>this.renderLicenceCreatedModal(!1)},o.createElement("em",null,"the full eBook is in your ",o.createElement("a",{href:`${p.a.getMarketplaceUrl("dashboard")}`,style:{color:"white"}},"library")," for you to download or save at your leisure")),document.getElementById("full-screen-modal"))}renderUpsellModal(e=!0,t,n,a){r.render(o.createElement(u.a,{isShown:e,spentTokenAmount:n,spentDollarAmount:a,productTitle:m.a.cleanBookTitle(t&&t.title),onBuy:()=>{f.a.isEbookInShoppingCart(t)?f.a.requestMenuOpen():f.a.requestAddBookToCart(t)},topOffset:h.a.getNavbarHeightInPx(),onClose:()=>this.renderUpsellModal(!1)}),document.getElementById("full-screen-modal"))}buyTokens(e){f.a.addTokensToCart(e),d.a.setTimeout(()=>f.a.requestMenuOpen(),150)}}const T=new b},401:function(e,t,n){var o=n(88),r=n(402);"string"==typeof(r=r.__esModule?r.default:r)&&(r=[[e.i,r,""]]);var a={insert:"head",singleton:!1};o(r,a);e.exports=r.locals||{}},402:function(e,t,n){(t=n(89)(!1)).push([e.i,"body.unlock-supported .readable-text{position:relative}body.unlock-supported #book-markup-container ul,body.unlock-supported #book-markup-container ol{position:relative}body.unlock-supported .readable-text.scrambled{cursor:pointer}body.unlock-supported .readable-text.scrambled:hover .token-icon-container svg,body.unlock-supported .readable-text.scrambled .unscramble-target .token-icon-container svg{transform:rotateY(360deg);transition-duration:1.2s}.unscramble-target p,li.unscramble-target{background-color:rgba(218,218,218,0.7)}.unscrambling p,li.unscrambling{background-color:rgba(218,218,218,0.25)}body.unlock-supported:not(.free-preview-mode) .scrambled p:hover,body.unlock-supported:not(.free-preview-mode) li.scrambled:hover{background-color:rgba(218,218,218,0.7)}.callout-container .unscramble-target p,.callout-container li.unscramble-target,.callout-container .unscrambling p,.callout-container li.unscrambling{background-color:#ececec}.readable-text.scrambled{color:#747474}.unlock-confirm-modal .unlock-confirm-root .unlock-confirm-price-container{font-size:16px}\n",""]),e.exports=t},58:function(e,t,n){"use strict";n.r(t),n.d(t,"UnlockText",(function(){return h}));var o=n(13),r=n(4),a=n(8),i=n(3),s=n(121),l=n(29),u=n(19);const c=$(document),d=1.2;const h=new class{constructor(){this.handleUnlockSuccess=this.handleUnlockSuccess.bind(this)}initialize(e,t){null!=t&&t.isOpen||null==t.bookElementPriceInfo||e&&(i.a.isUnlockingWholeContentThroughPointingLink||(this.book=e,this.bookElement=t,$(document.body).addClass("unlock-supported"),c.on("unlockSuccess",this.handleUnlockSuccess),this.book.isParagraphByParagraphUnlockDisabled||$(".readable-text.scrambled").on("click",this.handleScrambledTextClick)))}clean(){c.off("unlockSuccess",this.handleUnlockSuccess),$(".scrambled").off(),$(document.body).removeClass("unlock-supported")}getParagraphsPrice(e){if(null==e||0==e.length)return;if(null==this.bookElement||null==this.bookElement.bookElementPriceInfo)return;let t=0;return e.forEach(e=>t+=this.getParagraphPrice(e)),Math.max(t,0)}getParagraphPrice(e){if(null==this.bookElement||null==this.bookElement.bookElementPriceInfo)return 0;if(!e||!e.length)return 0;const t=(this.bookElement.wordCount||0)-(this.bookElement.freeWordCount||0);if(t<=0)return;const n=this.bookElement.bookElementPriceInfo.fullTokenPrice;if(n<=0)return;let o=e.text();return e.find(".scrambled-notifier").length&&(o=o.replace(e.find(".scrambled-notifier").text(),"")),Math.max(Math.ceil(d*(a.a.getNumberOfWords(o)/t)*n),0)}handleUnlockSuccess(e,t){t!=s.a.FreePreview&&"FreePreview"!=t&&r.a.setTimeout(()=>{this.book&&this.bookElement&&this.book.shortName&&this.bookElement.shortName&&u.a.getCompleteBookElementPriceInfo(this.book.shortName,this.bookElement.shortName,this.bookElement.meapVersion).then(e=>{null!=e&&0!=e.tokenPrice&&(this.bookElement.bookElementPriceInfo=e)}).catch(e=>{console.log("Cannot get book element price info")})},50)}handleScrambledTextClick(e){if($(e.target).is("a"))return;if($(document.body).is(".free-preview-mode"))return;const t=$(e.currentTarget);t.is(".scrambled")&&l.a.showModalForCurrentBookElementPurchases(null,o.a.expandListOfScrambledParagraphsIfNecessary([t]))}}},63:function(e,t,n){"use strict";n.r(t),n.d(t,"UnlockContentManager",(function(){return O}));var o=n(87),r=n(97);class a extends Error{constructor(e){super(e||"Promise was canceled"),this.name="CancelError"}get isCanceled(){return!0}}class i{constructor(e){this._cancelHandlers=[],this._isPending=!0,this._isCanceled=!1,this._promise=new Promise((t,n)=>(this._reject=n,e(e=>{this._isPending=!1,t(e)},e=>{this._isPending=!1,n(e)},e=>{this._cancelHandlers.push(e)})))}static fn(e){return(...t)=>new i((n,o,r)=>{t.push(r),e(...t).then(n,o)})}then(e,t){return this._promise.then(e,t)}catch(e){return this._promise.catch(e)}finally(e){return this._promise.finally(e)}cancel(e){if(this._isPending&&!this._isCanceled){if(this._cancelHandlers.length>0)try{for(const e of this._cancelHandlers)e()}catch(e){this._reject(e)}this._isCanceled=!0,this._reject(new a(e))}}get isCanceled(){return this._isCanceled}}Object.setPrototypeOf(i.prototype,Promise.prototype);var s=n(255),l=n.n(s),u=n(1),c=n(11),d=n(4),h=n(169),m=n(21),p=n(13),f=n(28),g=n(333),k=n(58),b=n(8),T=n(12),I=n(25),v=n(121);class y{constructor(e){this.$readableTexts=e,v.b.markParagraphsForUnscrambling(e)}startUnlockAnimation(){this.fadeOutAllText()}revertAnimation(){this.fadeInAllText()}fadeOutAllText(){const e=$($.map(this.$readableTexts,e=>e.get()));e.velocity({opacity:0},{duration:2e3,complete:()=>{this.isUnscrambledTextInserted||e.velocity({opacity:1},{duration:2e3,complete:()=>{this.isUnscrambledTextInserted||this.fadeOutAllText()}})}})}fadeInAllText(){const e=$($.map(this.$readableTexts,e=>e.get()));e.velocity("stop"),e.velocity({opacity:1},{duration:250})}insertUnscrambledContent(e){for(let t=0;t<this.$readableTexts.length;t++){const n=this.$readableTexts[t],o=n.attr("refid"),r=e.find(e=>e.paragraphID==o);r&&(n.html(r.content),n.removeClass("scrambled unscrambling"),n.addClass("unscrambled"),n.find(".scrambled-notifier").remove(),n.removeClass("scrambled unscrambling"),n.addClass("unscrambled"),n.attr("data-original-html",""))}}unlockWithAnimations(e){this.fadeInAllText(),e&&e()}}var P=n(5),C=n(6);n(401);const w=$(document),E='<div id="unscramble-info-modal" class="reveal-modal" data-reveal>\n    <span class="close-reveal-modal"><i class="fal fa-times"></i></span>\n    <div class="row">\n        <div class="small-12 columns unscramble-info-modal-content-container">\n            {{{UNSCRAMBLE_INFO_CONTENT}}}\n        </div>\n    </div>\n</div>';const O=new class{constructor(){this.$unscrambleInfoModal=$("#unscramble-info-modal"),0==this.$unscrambleInfoModal.length&&($(document.body).append(E),this.$unscrambleInfoModal=$("#unscramble-info-modal")),d.a.onDescendantEventWithCooldown(this.$unscrambleInfoModal,"click touchstart",".add-to-cart-button",()=>this.addCurrentBookToCart()),d.a.onDescendantEventWithCooldown(this.$unscrambleInfoModal,"click touchstart",".view-in-cart-button",()=>{this.hideOutOfTokensModal(),setTimeout(()=>I.a.requestMenuOpen(),300)}),d.a.onDescendantEventWithCooldown(this.$unscrambleInfoModal,"click touchstart",".buy-tokens-button",()=>{this.hideOutOfTokensModal()}),w.on("shoppingCartItemsChanged",()=>this.updatePurchaseButtons())}initialize(e,t){this.book=e,this.bookElement=t,this.fetchAndDisplayLatestTokenInfo()}clean(){this.book=null,this.bookElement=null}fetchAndDisplayLatestTokenInfo(e=!1){C.a.isCurrentlyLoggedIn()?h.a.getTokenCountInfo(e).then(e=>{this.refreshTokenStateInToolbar(e)}).catch(e=>{this.refreshTokenStateInToolbar({availableCompedTokenCount:0,availablePurchasedTokenCount:0})}):this.refreshTokenStateInToolbar({availableCompedTokenCount:0,availablePurchasedTokenCount:0})}tryToSearchUnlockFragmentInCurrentBookElement(e){this.unlockFragments(this.book,this.bookElement,v.a.Search,"",e)}tryToUnlockTocBookElement(e,t,n){C.a.isLoggedIn().then(o=>{if(o.loggedIn){this.hasEnoughTokens(n,o.userDetails&&o.userDetails.tokenInfo)?(m.a.showTemporaryNotification("Unlocking content ..."),this.getUnlockTocBookElementPromise(e,t).then(e=>{w.trigger("unlockSuccess",[v.a.BookElement]),m.a.showTemporaryNotification(`Unlock success. Loading ${t}.`),d.a.setTimeout(()=>{f.a.openLink(f.a.formLinkFromBookSlugAndBookElementShortName(this.book.slug,t)),u.a.reloadPage()},2e3)}).catch(e=>{w.trigger("unlockFailure",[v.a.BookElement,[]]),m.a.showTemporaryNotification(`Error unlocking ${t}. Try later.`)})):this.showOutOfTokensModal()}else this.showLoginModal("Want to see more? Just sign in and use tokens to unlock this content.")})}hasEnoughTokens(e,t){return null!=t&&this.getTotalNumberOfTokens(t)>=e}unlockFragments(e,t,n,o,r,a,s,l){return new i((i,u,c)=>{C.a.isLoggedIn().then(d=>{const p=n==v.a.Search,f=n==v.a.FreePreview;if(d.loggedIn||f){const a=r.map(e=>e.attr("id"));let k=s||this.getTokenCost(r);this.getTotalNumberOfTokens(d.userDetails&&d.userDetails.tokenInfo);if(f||p||this.hasEnoughTokens(k,d.userDetails&&d.userDetails.tokenInfo)){const r=this.unlockContent(t,n,o,a,l).then(e=>{v.b.replaceEncryptedContent($("body"),e.ownedContent||e.unlockedParagraphs),w.trigger("paragraphsUnlocked",[a]),p||f||null!=e.tokenInfo&&(h.a.setTokenCountInfo(e.tokenInfo),this.refreshTokenStateInToolbar(e.tokenInfo)),w.trigger("unlockSuccess",[v.a[n]]),i(e),setTimeout(()=>{e.licenseCreated?g.TokenModal.renderLicenceCreatedModal():e.productTokenInfo&&e.productTokenInfo.spentAmountInDollars&&e.productTokenInfo.spentAmountInTokens&&I.a.getBookPrice(this.book).then(t=>{e.productTokenInfo.spentAmountInDollars>=.25*t&&g.TokenModal.renderUpsellModal(!0,this.book,e.productTokenInfo.spentAmountInTokens,e.productTokenInfo.spentAmountInDollars)})},100)}).catch(t=>{let o="Error when unlocking content";p?o="Unfortunatly, you've exceeded the search unscrambling limit for this book. Try again tomorrow.":f&&(o="Unfortunatly, you've exceeded the free preview limit for this book. Try again tomorrow."),null!=t.remainingPreviewDuration&&t.remainingPreviewDuration<0||(m.a.showTemporaryNotification(o),w.trigger("unlockFailure",[v.a[n],a]),u(t),t&&t.outOfSingleParagraphUnlocks&&(w.trigger("outOfParagraphByParagraphUnlocks"),g.TokenModal.renderOutOfParagraphByParagraphUnlocks(!0,t.reason),e&&(e.isParagraphByParagraphUnlockDisabled=!0)))});c(()=>r&&r.cancel())}else this.showOutOfTokensModal()}else this.showLoginModal("Want to see more? Just sign in"+(n==v.a.Search?" and the paragraph will unlock for you.":" and use tokens to unlock this content.")),this.setOriginalLinkLocation(a)})})}tryToUnlockPointedParagraph(e,t,n,o){if(!e||!t||!n||n.length<2)return;const r=v.b.getDataFromPointingLink(e,t,n);if(null==r)return;const a=[];for(let e=r.startParagraphId;e<=r.endParagraphId;e++){const t=document.getElementById(e);t&&a.push($(t))}const i=v.b.isEncompassingWholeContent(r.startParagraphId,r.endParagraphId);i||a.forEach(e=>e.addClass("paragraph-selected"));let s=a.filter(e=>e.is(".scrambled"));r.paragraphsToUnlock=s.map(e=>e.attr("id")).join(","),w.trigger("pointingLinkOpened",[r.pointingLinkId,i]),s.length?r.isUserEditorLink?this.unlockPointedParagraphs(e,s,r.startParagraphId,r.endParagraphId,r):C.a.isLoggedIn().then(t=>{if(t.loggedIn){let n=Math.max(this.getTokenCost(s),1);if(!(this.getTotalNumberOfTokens(t.userDetails&&t.userDetails.tokenInfo)>=n))return void m.a.showTemporaryNotification("You don't have enough tokens to unlock the whole pointed content");m.a.showNotificationModal("Confirm",`Spend ${n} ${n>1?"tokens":"token"} to unlock this content?`,!0,()=>this.unlockPointedParagraphs(e,s,r.startParagraphId,r.endParagraphId,r))}else this.showLoginModal("Want to see more? Just sign in."),this.setOriginalLinkLocation(o)}):r.pointingLinkId&&this.reportPointingLinkUsed(r.pointingLinkId)}unlockPointedParagraphs(e,t,n,o,r){const a=new y(t);a.startUnlockAnimation(),u.a.getFromOurBackend(u.a.getAbsoluteUrl("api/pointing/getPointedContent"),e=>{a.insertUnscrambledContent(e.paragraphInfos||[]),a.unlockWithAnimations(),w.trigger("unlockSuccess",[v.a[v.a.Point]]),null!=e.tokenInfo&&(h.a.setTokenCountInfo(e.tokenInfo),this.refreshTokenStateInToolbar(e.tokenInfo))},e=>{m.a.showNotification("Error when trying to unlock. Please try later."),w.trigger("unlockFailure",[!1,!0,[n,o]]),a.revertAnimation()},r)}reportPointingLinkUsed(e){u.a.getFromOurBackend(u.a.getAbsoluteUrl("api/pointing/reportSimpleUse"),e=>{},e=>{},{pointingLinkId:e})}unlockContent(e,t,n,o,r={}){return new i((a,i,s)=>{const l=new y(o.map(e=>$(document.getElementById(e))));l.startUnlockAnimation(),Promise.all([this.getUnlockBookElementContentPromise(e,t,n,o,r),b.a.getTimeoutPromise(500)]).then(e=>{const t=e[0];if(!t.success)return null!=l&&l.revertAnimation(),void i(t);t.tokenInfo&&this.refreshTokenStateInToolbar(t.tokenInfo),l.insertUnscrambledContent(t.ownedContent||t.unlockedParagraphs),l.unlockWithAnimations(()=>a(t))}).catch(e=>{null!=l&&l.revertAnimation(),i(e)})})}getUnlockTocBookElementPromise(e,t){return new Promise((n,o)=>{u.a.postToOurBackend(u.a.getAbsoluteUrl("api/userBook/unlockTocBookElement"),e=>n(e),e=>o(e),{bookShortName:e.shortName,bookElementShortName:t,meapVersion:this.bookElement.meapVersion})})}getUnlockBookElementContentPromise(e,t,n,o,r){return new i((a,i,s)=>{let l=this.getUnlockBookElementContentApiSendData(e,t,n,o,r);u.a.postToOurBackend(u.a.getAbsoluteUrl("api/userBook/unlockBookElementContent"),t=>{t&&(t.ownedContent?this.fixOwnedContentImages(t.ownedContent):t.unlockedParagraphs&&this.fixOwnedContentImages(t.unlockedParagraphs),t.productTokenInfo&&e.book&&(e.book.spendingInfo={spentTokenAmount:t.productTokenInfo.spentAmountInTokens,spentDollarAmount:t.productTokenInfo.spentAmountInDollars},w.trigger("bookSpendingInfoArrived"))),a(t)},e=>i(e),l)})}getUnlockBookElementContentApiSendData(e,t,n,o,r){const a={bookShortName:e.book.shortName,bookElementShortName:e.shortName,paragraphIDs:(o||[]).join(","),meapVersion:e.meapVersion,isSearch:t==v.a.Search,isFreePreview:t==v.a.FreePreview,logTimings:!!P.a.getItem("logTimings")};switch(t){case v.a.BookElement:delete a.paragraphIDs;break;case v.a.Section:a.sectionShortName=n;break;case v.a.Subsection:a.subsectionShortName=n}try{if(r&&r instanceof Object)for(const e in r)a[e]=r[e]}catch(e){console.log("Error when adding additional parameters when unlocking")}return a}fixOwnedContentImages(e){if(!e)return e;for(let t=0;t<e.length;t++)e[t].content=e[t].content.replace(/\{\{BOOK_ROOT_FOLDER\}\}/g,u.a.getAwsPublic())}addCurrentBookToCart(){I.a.requestAddBookToCart(this.book)}updatePurchaseButtons(){this.book?(this.$unscrambleInfoModal.find(".add-to-cart-button").toggleClass("hidden",this.book.userOwnsBook||I.a.isEbookInShoppingCart(this.book)),this.$unscrambleInfoModal.find(".view-in-cart-button").toggleClass("hidden",!I.a.isEbookInShoppingCart(this.book)),this.$unscrambleInfoModal.find(".buy-tokens-button").toggleClass("hidden",!0)):this.$unscrambleInfoModal.find(".add-to-cart-button, .buy-tokens-button, .view-in-cart-button").addClass("hidden")}refreshTokenStateInToolbar(e){const t=$(".token-amount-container");let n=parseInt(t.first().text().replace(",","")||"0");Number.isNaN(n)&&(n=0);const a=(e.availableCompedTokenCount||0)+(e.availablePurchasedTokenCount||0);if(0==a||0==n||0==t.filter(":visible").length)t.each((e,t)=>{r.unmountComponentAtNode(t)}),t.html(`${b.a.numberWithCommas(a||"")}`);else try{r.render(o.createElement(l.a,{start:n,end:a,duration:1.5,separator:",",onStart:()=>{n!=a&&t.addClass("counting glow-text")},onEnd:()=>{t.removeClass("counting glow-text")}}),t.filter(":visible")[0])}catch(e){t.each((e,t)=>{r.unmountComponentAtNode(t)}),t.html(`${a||""}`)}}showLoginModal(e=""){T.a.requestOpenModal("signin",e,"microtransactions")}showOutOfTokensModal(){g.TokenModal.renderOutOfTokensNotifier(this.book),this.updatePurchaseButtons()}hideOutOfTokensModal(){c.a.hideFoundationModal(this.$unscrambleInfoModal)}getTotalNumberOfTokens(e){return null==e?0:(e.availableCompedTokenCount||0)+(e.availablePurchasedTokenCount||0)}getTokenCost(e){return k.UnlockText.getParagraphsPrice(p.a.expandListOfScrambledParagraphsIfNecessary(e.filter(e=>e.is(".scrambled"))))}setOriginalLinkLocation(e){e&&d.a.setTimeout(()=>{e&&history.pushState({},document.title,e)},400)}}}}]);
//# sourceMappingURL=unlockManager.chunk.js.map?65cbb3a93f27ef23b510