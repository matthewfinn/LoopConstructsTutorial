(window.webpackJsonp=window.webpackJsonp||[]).push([[86,65],{1197:function(t,e,i){"use strict";i.r(e),i.d(e,"TextSelectionManager",(function(){return k}));var n=i(4),o=i(0),s=i(231),a=i(188),r=i(22),l=i(11),h=i(30),c=i(164),g=i(197),d=i(3),u=i(221),p=i(1),m=i(28);var f=new class{createSimpleLink(t,e,i){return""}createPointingLink(t,e,i,n=!0){const o=this.createSimpleLink(t,e,i);return new Promise((s,a)=>{p.a.getFromOurBackend(p.a.getAbsoluteUrl("api/pointing/create"),t=>{t.link=m.a.adjustBookLink(t.link||"");const e=p.a.getClientAbsoluteUrl(t.link);n?$.ajax({url:"https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyBX77QKufqi8RxQeDQ4ziGbcl1XuZ9Uayw",method:"post",contentType:"application/json; charset=utf-8",data:'{ longUrl: "'+e+'"}'}).done(t=>{s(t&&t.id?t.id:e)}).fail(t=>{s(e)}):s(e)},t=>{console.log("Error when producing the pointing link",t),s(o)},{bookShortName:t.shortName,bookElementShortName:e.shortName,meapVersion:e.meapVersion,paragraphIds:i.join(",")})})}},S=i(222);const P=$(document);let b=o.b.isTouchDevice();const x="<div class='text-selection-tooltip-container'>\n    <i class='fal fa-highlighter highlight-button' aria-hidden='true' title='highlight'></i>\n    <i class='fal fa-bookmark bookmark-button' title='bookmark'></i>\n    <i class='fal fa-sticky-note note-button' title='annotate'></i>\n    <i class='fal fa-link link-button' title='create link'></i>\n    <i class='fal fa-comments forum-button' title='discussion'></i>\n    <i class='fal fa-exclamation-triangle error-report' title='report error'></i>\n    <i class='fal fa-tag create-term-text-selection-icon' title='create new term'></i>\n</div>",T=new class{constructor(){this.isTextSelectionActionEnabled=!0,this.handlePointerPressStart=this.handlePointerPressStart.bind(this),this.handlePointerPressEnd=this.handlePointerPressEnd.bind(this),this.handlePointerOnHover=this.handlePointerOnHover.bind(this),P.on("requestShowTooltip",()=>this.showTooltip())}initialize(){d.a.book&&d.a.bookElement&&(P.on("mousedown touchstart",this.handlePointerPressStart),o.b.isTouchDevice()?n.a.onEventWithCooldown(P,"mouseup touchend selectionchange",this.handlePointerPressEnd):n.a.onEventWithCooldown(P,"mouseup touchend",this.handlePointerPressEnd))}clean(){this.$selectedFragments=[],P.off("mousedown touchstart",this.handlePointerPressStart),P.off("mouseup touchend selectionchange",this.handlePointerPressEnd);try{this.hideToolTips()}catch(t){}$(".scrambled").off()}handlePointerOnHover(t){if(window.getSelection().toString().trim().length)return;const e=$(t);this.$selectedFragments&&0!==this.$selectedFragments.length&&this.$selectedFragments.find(t=>t.attr("refid")==e.attr("refid"))||(this.$selectedFragments=[e])}handlePointerPressStart(t){const e=$(t.target);if(!e.is(".highlighted-text"))if(e.closest(".tooltip").length<=0)this.hideTextSelectionTooltip();else if(this.isTextSelectionActionEnabled){if(e.is(".note-button"))this.hideToolTips(),this.highlightCurrentNoteSelection(),this.annotateCurrentSelection(),this.isTextSelectionActionEnabled=!1;else if(e.is(".highlight-button"))this.hideToolTips(),this.highlightCurrentSelection(),this.isTextSelectionActionEnabled=!1;else if(e.is(".bookmark-button"))this.hideToolTips(),this.bookmarkCurrentSelection(),this.isTextSelectionActionEnabled=!1;else if(e.is(".link-button"))this.hideToolTips(),d.a.book&&this.$selectedFragments&&(P.trigger("paragraphsSelected",[this.$selectedFragments]),a.PointingSelection.createPointingSelection(d.a.book,d.a.bookElement,{$selectedParagraphs:this.$selectedFragments,createAction:t=>f.createPointingLink(d.a.book,d.a.bookElement,t,!1)})),this.isTextSelectionActionEnabled=!1;else if(e.is(".forum-button")){if(this.hideToolTips(),d.a.book&&this.$selectedFragments){const t=this.$selectedFragments[0];t&&t[0]&&(c.a.createParagraphBubble(t[0]),$(t[0].paragraphBubble).add("activated"),r.a.requestOpenParagraphSideMenu(t[0].paragraphBubble))}this.isTextSelectionActionEnabled=!1}else if(e.is(".error-report")){if(this.hideToolTips(),d.a.book&&this.$selectedFragments){const t=this.$selectedFragments[0];t&&t[0]&&h.a.showContentErrorReportModal("Found an error:\n"+this.currentTextSelection,this.$selectedFragments[0].attr("data-hash")||this.$selectedFragments[0].attr("refId"))}this.isTextSelectionActionEnabled=!1}else e.is(".create-term-text-selection-icon")&&(this.hideToolTips(),d.a.book&&this.$selectedFragments&&(S.a.requestTermCreation(+this.$selectedFragments[0].attr("refId"),this.$selectedFragments[0].attr("data-hash"),this.currentTextSelection),this.clearTextSelection()));this.isTextSelectionActionEnabled||setTimeout(()=>{this.isTextSelectionActionEnabled=!0},300)}}handlePointerPressEnd(t){if(!this.isTextSelectionActionEnabled)return;let e=null,i=null,o=!1;const s=$(t.target);s.closest(".tooltip").length||s.is("#book-markup-container")||s.closest("#pointing-info-box").length||n.a.setTimeout(()=>{const t=window.getSelection();if(0===t.rangeCount)return;const n=t.getRangeAt(0);if(e=$(n.startContainer).parents(".readable-text"),i=$(n.endContainer).parents(".readable-text"),0===n.endOffset&&e.attr("id")!=i.attr("id")&&(i=i.prev()),0===e.length)return;this.currentTextSelection=t.toString().trim(),this.currentTextSelectionStartOffset=-1,o=this.currentTextSelection.length>=2;const s=parseInt(e.attr("id")),a=parseInt(i.attr("id"));if(Number.isNaN(s)||Number.isNaN(a))return;this.$selectedFragments=[];for(let t=s;t<=a;t++){const e=$(document.getElementById(t+""));e.length&&this.$selectedFragments.push(e)}this.currentTextSelectionStartOffset=this.getCurrentlySelectedOffset(),!!!this.$selectedFragments.find(t=>t.is(".scrambled, .temp-unscrambled"))&&o&&this.showTooltip(this.isBackwardSelection(t))},150)}getCurrentlySelectedOffset(){const t=window.getSelection(),e=t.anchorNode,i=l.a.getFirstBlockAncestor(e);if(null==i||null==e)return-1;const n=l.a.getAllDescendantTextNodes(i);let o=t.anchorOffset;for(let t=0;t<n.length;t++){const i=n[t];if(i==e)return o;o+=i.textContent.length}return-1}isBackwardSelection(t){let e=!1;try{const i=t.anchorNode.compareDocumentPosition(t.focusNode);(!i&&t.anchorOffset>t.focusOffset||i===Node.DOCUMENT_POSITION_PRECEDING)&&(e=!0)}catch(t){console.log("Error when determining backward selection",t)}return e}showTooltip(t=!1){let e=null;e=window.getSelection().getRangeAt(0).getBoundingClientRect();let i=(t&&!b?e.top:e.bottom)+P.scrollTop()+(t?40:20)+(b?20:0),n=e.left+e.width/2;const o=$(window).width();n+250>=o&&(n-=Math.abs(o-n-250)),n<0&&(n=0),l.a.showTooltipAtAbsolutePosition({top:i,left:n},x),P.trigger("tooltipOpened")}hideToolTips(){this.hideTextSelectionTooltip()}hideTextSelectionTooltip(){l.a.hideTooltip(),P.trigger("tooltipClosed")}highlightCurrentNoteSelection(){this.$selectedFragments[0]&&0!=this.$selectedFragments[0].length&&this.currentTextSelection&&s.a.highlightNoteSelection(this.$selectedFragments[0],this.currentTextSelection,"-1",this.currentTextSelectionStartOffset)}highlightCurrentSelection(){this.$selectedFragments[0]&&0!=this.$selectedFragments[0].length&&this.currentTextSelection&&(s.a.createHighlightSelection(this.$selectedFragments,this.currentTextSelection,this.currentTextSelectionStartOffset),this.clearTextSelection())}bookmarkCurrentSelection(){this.$selectedFragments[0]&&0!=this.$selectedFragments[0].length&&this.currentTextSelection&&(c.a.toggleBookmark(this.$selectedFragments[0][0]),this.clearTextSelection())}annotateCurrentSelection(){this.$selectedFragments[0]&&0!=this.$selectedFragments[0].length&&(d.a.bookElement&&d.a.bookElement.reviewVersion>0?u.a.annotate(this.$selectedFragments[0].get(0),this.currentTextSelection,this.currentTextSelectionStartOffset):g.a.annotate(this.$selectedFragments[0].get(0),this.currentTextSelection,this.currentTextSelectionStartOffset))}clearTextSelection(){window.getSelection&&(window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges())}};const k=new class{initialize(t){T.initialize(),t||(s.a.initialize(),a.PointingSelection.initialize())}clean(){T.clean()}handlePointerPressStart(t){T.initialize(),T.handlePointerPressStart(t)}}},133:function(t,e,i){"use strict";var n=i(8),o=i(11);e.a=new class{highlight(t,e,i,s="",a="",r={}){if(!t)return;const l=$(t);l.is(".fragment-played")&&(s="");const h=o.a.getAllDescendantTextNodes(t),c=o.a.createTextNodeTextRanges(h);let g=n.a.getStartIndex(c.value,e,a),d=g+e.length;if(-1===g&&(d=(g=c.value.indexOf(e.replace("<","&lt;").replace(">","&gt;")))+e.length,-1==g))return;const u=o.a.splitRanges(c,g,d);if(this.markVisibleParentNodeElements(t,u.followingRanges,s),this.liftWordsInMatchingRanges(u.matchingRanges,g,d,i,s,r),this.liftWordsInFollowingRanges(u.followingRanges,s),""!=s.trim()){const t="."+s.trim().replace(/\s+/,".");l.find(t).each((function(t,e){const i=$(e.nextSibling);i.is("img")&&i.addClass(s)}))}}liftWordsInMatchingRanges(t,e,i,n,s,a){for(let r=0,l=t.length;r<l;r++){const h=t[r],c=h.textNode.nodeValue;if(0==r){const t=e-h.start,r=i-h.start,l=c.substring(0,t),g=c.substring(t,r),d=c.substring(r,h.end);$(h.textNode).replaceWith(l+o.a.wrapToHtmlElement("span",Object.assign({class:n},a),g)+(""!=d&&""!=s?o.a.wrapToHtmlElement("span",{class:s},d):d))}else if(r==l-1){const t=i-h.start,e=c.substring(0,t),r=c.substring(t,c.length);$(h.textNode).replaceWith(o.a.wrapToHtmlElement("span",Object.assign({class:n},a),e)+(""!=r&&""!=s?o.a.wrapToHtmlElement("span",{class:s},r):r))}else $(h.textNode).replaceWith(o.a.wrapToHtmlElement("span",Object.assign({class:n},a),c))}}liftWordsInFollowingRanges(t,e){if(e)for(let i=0;i<t.length;i++){const n=t[i];n.textNode.nodeValue&&n.textNode.nodeValue.trim()&&$(n.textNode).replaceWith(o.a.wrapToHtmlElement("span",{class:e},n.textNode.nodeValue))}}markVisibleParentNodeElements(t,e,i){if(t&&e&&0!=e.length&&i)for(let t=0;t<e.length;t++){const n=e[t].textNode;"KBD"==n.parentNode.nodeName&&$(n.parentNode).addClass(i)}}}},188:function(t,e,i){"use strict";i.r(e),i.d(e,"PointingSelection",(function(){return u}));var n=i(4),o=i(13),s=i(9),a=i(21),r=i(2),l=(i(319),i(8));const h=$(document),c=$(window);var g;!function(t){t[t.Default=0]="Default",t[t.DisplayingActionResult=1]="DisplayingActionResult"}(g||(g={}));const d='\n<div>\n    <div class="pointing-info-left-container">\n        {{#isDefault}}\n        {{^hideLinkIcon}}\n        <i class="fal fa-fw fa-link pointing-info-create-link-icon" aria-hidden="true" title="{{actionLabel}}"></i>\n        {{/hideLinkIcon}}\n        {{/isDefault}}\n        {{#error}}\n        <i class="fal fa-fw fa-undo pointing-info-try-again-icon" aria-hidden="true" title="try again"></i>\n        {{/error}}\n        {{#pointingLink}}\n        <i class="fal fa-fw fa-clipboard copy-to-clipboard" title="copy to clipboard" aria-hidden="true"></i>\n        {{/pointingLink}}\n        {{#isLoading}}\n        <i class="fal fa-fw fa-spinner fa-spin" title="loading..." aria-hidden="true"></i>\n        {{/isLoading}}\n    </div>\n    <div class="pointing-info-middle-container">\n        {{#isDefault}}\n        <a href="javascript:void(0)" class="pointing-info-create-action-link">{{actionLabel}}</a>\n        {{/isDefault}}\n        {{#error}}\n        <span class="error-message"> {{error}} </span>\n        {{/error}}\n        {{#pointingLink}}\n        <input readOnly type="text" value="{{pointingLink}}"/>\n        {{/pointingLink}}\n        {{#isCreatingLink}}\n        <span>Creating link ...</span>\n        {{/isCreatingLink}}\n    </div>\n    <div class="pointing-info-right-container">\n        <i class="fal fa-times pointing-info-close"></i>\n    </div>\n</div>',u=new class{constructor(){this.dragStartPosition=0,this.$draggedPoint=null,this.singleSelectedParagraphIds=[],this.pointingInfoBox=document.getElementById("pointing-info-box"),null==this.pointingInfoBox&&($(document.body).append('<div id="pointing-info-box"></div>'),this.pointingInfoBox=document.getElementById("pointing-info-box")),this.$pointingInfoBox=$(this.pointingInfoBox),this.handleBoxClose=this.handleBoxClose.bind(this),this.handleParagraphClick=this.handleParagraphClick.bind(this),this.handleActionClick=this.handleActionClick.bind(this),this.handlePositionPointMouseDown=this.handlePositionPointMouseDown.bind(this),this.handleDocumentMouseMove=this.handleDocumentMouseMove.bind(this),this.handleDocumentMouseUp=this.handleDocumentMouseUp.bind(this),this.handleDragPaused=this.handleDragPaused.bind(this),this.handleResizeStop=this.handleResizeStop.bind(this),h.on("mouseup",this.handleDocumentMouseUp),this.$pointingInfoBox.on("click",".pointing-info-close",this.handleBoxClose),this.$pointingInfoBox.on("click",".pointing-info-create-link-icon, .pointing-info-try-again-icon, .pointing-info-create-action-link",this.handleActionClick)}initialize(){this.clean()}isSelectingParagraphs(){return null!=this.$pointingInfoBox&&this.$pointingInfoBox.is(".shown")}clean(){this.startSectionParagraph=null,this.endSectionParagraph=null,this.$draggedPoint=null,this.error="",this.pointingLink="",this.config=null,this.state=g.Default,this.$pointingInfoBox.is(".shown")&&this.hideBox(),h.off("mousemove",this.handleDocumentMouseMove),c.off("resizestop",this.handleResizeStop),clearTimeout(this.dragPauseTimeoutId)}createPointingSelection(t,e,i){const n=i.$selectedParagraphs||[];this.singleSelectedParagraphIds=n.map(t=>t.attr("id")),this.startSectionParagraph=n&&n.length?n[0][0]:null,this.endSectionParagraph=n&&n.length?n[n.length-1][0]:null,this.$pointingStartPoint=$("#pointing-start-point"),this.$pointingEndPoint=$("#pointing-end-point"),this.$pointingStartPoint.off("mousedown",this.handlePositionPointMouseDown),this.$pointingEndPoint.off("mousedown",this.handlePositionPointMouseDown),this.$pointingStartPoint.on("mousedown",this.handlePositionPointMouseDown),this.$pointingEndPoint.on("mousedown",this.handlePositionPointMouseDown);const s=o.a.getTextFragmentElements();s&&s[s.length-1]?this.lastParagraphId=s[s.length-1].id:this.lastParagraphId=1e3,this.state=g.Default,this.error="",this.pointingLink="",this.config=i,this.renderCurrentState(),this.showBox(),this.makeParagraphsClickable()}handlePositionPointMouseDown(t){const e=$(t.currentTarget);return this.$draggedPoint=e,h.on("mousemove",this.handleDocumentMouseMove),this.dragStartPosition=t.pageY,t.preventDefault(),t.stopImmediatePropagation(),!1}handleDocumentMouseMove(t){if(!this.$draggedPoint)return;clearTimeout(this.dragPauseTimeoutId);const e=t.pageY-this.dragStartPosition,i=s.a.getComputedTranslateY(this.$draggedPoint[0]);this.$draggedPoint.css("transform",`translateY(${i+e}px)`),this.dragStartPosition=t.pageY,this.dragPauseTimeoutId=setTimeout(this.handleDragPaused,100)}handleDocumentMouseUp(t){h.off("mousemove",this.handleDocumentMouseMove),this.handleDragPaused(t,!0),this.dragStartPosition=0,this.$draggedPoint=null}handleDragPaused(t,e){if(!this.$draggedPoint)return;const i=$(this.startSectionParagraph),n=$(this.endSectionParagraph);let o=this.$draggedPoint.is("#pointing-start-point");const a=s.a.getComputedTranslateY(this.$draggedPoint[0]),r=this.getStartIconPosition(),l=this.getEndIconPosition(),h=parseInt(i.attr("id")),c=parseInt(n.attr("id"));let d=null;if(a<r)for(let t=h;t>=0;t--){const e=document.getElementById(t+"");if(this.isReferentParagraph(e,a)){d=e;break}}else if(a>l){const t=this.lastParagraphId;for(let e=c;e<=t;e++){const t=document.getElementById(e+"");if(this.isReferentParagraph(t,a)){d=t;break}}}else for(let t=h;t<=c;t++){const e=document.getElementById(t+"");if(this.isReferentParagraph(e,a)){d=e;break}}if(d){const t=parseInt(d.id);o?t<=c?this.startSectionParagraph=d:(this.startSectionParagraph=this.endSectionParagraph,this.endSectionParagraph=d):t>=h?this.endSectionParagraph=d:(this.endSectionParagraph=this.startSectionParagraph,this.startSectionParagraph=d),!0===e?(this.error="",this.state=g.Default,this.pointingLink="",this.renderCurrentState()):this.highlightSelectedParagraphs()}else!0===e&&(this.error="",this.state=g.Default,this.pointingLink="",this.renderStartEndIcons())}handleResizeStop(){this.$pointingInfoBox&&this.$pointingInfoBox.is(".shown")&&this.renderStartEndIcons()}isReferentParagraph(t,e){if(!t)return!1;const i=this.getStartIconPositionForParagraph(t),n=this.getEndIconPositionForParagraph(t);return i<=e&&e<=n}renderCurrentState(){this.highlightSelectedParagraphs(),this.renderStartEndIcons(),this.$pointingInfoBox.html(Mustache.render(d,{hideLinkIcon:this.config.hideLinkIcon,isDefault:this.state==g.Default,error:this.error,pointingLink:this.pointingLink,isLoading:this.state!=g.Default&&!this.error&&!this.pointingLink,actionLabel:this.getActionLabel()})),this.$pointingInfoBox.find(".copy-to-clipboard").length&&this.handleCopyToCliboardElementCreated(),this.$pointingInfoBox.find("input").select()}getActionLabel(){return this.config&&this.config.selectSingleParagraphs?null!=this.singleSelectedParagraphIds&&0!=this.singleSelectedParagraphIds.length||null==this.config||!this.config.emptyLabel?(null!=this.config?this.config.actionLabel:"")||"create link":this.config.emptyLabel:this.startSectionParagraph||this.endSectionParagraph||null==this.config||!this.config.emptyLabel?(null!=this.config?this.config.actionLabel:"")||"create link":this.config.emptyLabel}hideBox(t){c.off("resizestop",this.handleResizeStop),$(document.body).removeClass("pointing-selection-shown"),this.$pointingInfoBox.removeClass("shown"),this.$pointingStartPoint.removeClass("shown"),this.$pointingEndPoint.removeClass("shown"),n.a.setTimeout(()=>{this.$pointingInfoBox.css("display","none"),t&&t()},250)}showBox(){$(document.body).addClass("pointing-selection-shown"),this.renderCurrentState(),this.$pointingInfoBox.css("display","block"),this.$pointingInfoBox.addClass("shown"),c.off("resizestop",this.handleResizeStop),c.on("resizestop",this.handleResizeStop)}handleBoxClose(){this.unmakeParagraphsClickable(),$(".paragraph-selected").removeClass("paragraph-selected"),this.hideBox(()=>this.clean())}makeParagraphsClickable(){$(".readable-text").addClass("clickable"),h.off("click",".readable-text",this.handleParagraphClick),h.on("click",".readable-text",this.handleParagraphClick)}unmakeParagraphsClickable(){$(".readable-text").removeClass("clickable"),h.off("click",".readable-text",this.handleParagraphClick)}handleParagraphClick(t){t.preventDefault(),t.stopImmediatePropagation();const e=t.currentTarget;let i=!1;if(this.config&&this.config.selectSingleParagraphs){const t=e.id;-1==this.singleSelectedParagraphIds.indexOf(t)?this.singleSelectedParagraphIds.push(t):l.a.removeItemFromArray(this.singleSelectedParagraphIds,t),i=!0}else{null==this.startSectionParagraph&&(this.startSectionParagraph=e),null==this.endSectionParagraph&&(this.endSectionParagraph=e);const t=parseInt(e.id),n=parseInt(this.startSectionParagraph.id),o=parseInt(this.endSectionParagraph.id);n+1!=o||t!==n&&t!==o?t===n||t===o?(this.startSectionParagraph=e,this.endSectionParagraph=e,i=!1):(t<=n&&(this.startSectionParagraph=e,i=!1),t>=o&&(this.endSectionParagraph=e,i=!1)):(this.startSectionParagraph=e,this.endSectionParagraph=e,i=!1),n<t&&t<o&&(Math.abs(n-t)<Math.abs(o-t)?(this.startSectionParagraph=e,i=!1):(this.endSectionParagraph=e,i=!1))}return i&&(this.state=g.Default,this.error="",this.pointingLink=""),this.renderCurrentState(),!1}handleActionClick(){if(this.config&&this.config.selectSingleParagraphs){if(null==this.singleSelectedParagraphIds||0==this.singleSelectedParagraphIds.length)return}else if(null==this.startSectionParagraph||null==this.endSectionParagraph)return;this.error="",this.pointingLink="",this.unmakeParagraphsClickable(),this.state=g.DisplayingActionResult,this.config.createAction(this.getSelectedParagraphs().map(t=>t.attr("id"))).then(t=>{this.config.automaticallyCloseOnActionDone?this.handleBoxClose():(this.pointingLink=t||"",this.renderCurrentState())}).catch(t=>{this.error="Error when creating pointing link",this.pointingLink="",this.renderCurrentState()}),this.renderCurrentState()}highlightSelectedParagraphs(){$(".paragraph-selected").removeClass("paragraph-selected"),this.getSelectedParagraphs().forEach(t=>t.addClass("paragraph-selected"))}renderStartEndIcons(){return this.config&&this.config.selectSingleParagraphs?(this.$pointingStartPoint.removeClass("shown"),void this.$pointingEndPoint.removeClass("shown")):this.$pointingStartPoint&&this.$pointingEndPoint?(this.$pointingStartPoint.addClass("shown"),this.$pointingEndPoint.addClass("shown"),void(this.$pointingStartPoint.is(".velocity-animating")||(this.$pointingStartPoint.velocity({translateY:[this.getStartIconPosition(),s.a.getComputedTranslateY(this.$pointingStartPoint[0])]},250),this.$pointingEndPoint.velocity({translateY:[this.getEndIconPosition(),s.a.getComputedTranslateY(this.$pointingEndPoint[0])]},250)))):(this.$pointingStartPoint.removeClass("shown"),void this.$pointingEndPoint.removeClass("shown"))}getStartIconPosition(){return this.getStartIconPositionForParagraph(this.startSectionParagraph)}getStartIconPositionForParagraph(t){return o.a.getTextElementPositionPointTop($(t))-this.$pointingStartPoint.height()/2}getEndIconPosition(){return this.getEndIconPositionForParagraph(this.endSectionParagraph)}getEndIconPositionForParagraph(t){const e=$(t);return o.a.getTextElementPositionPointTop(e)+e.height()-.4*this.$pointingEndPoint.height()}getSelectedParagraphs(){if(this.config&&this.config.selectSingleParagraphs)return(this.singleSelectedParagraphIds||[]).map(t=>$(document.getElementById(t)));if(this.startSectionParagraph||this.endSectionParagraph){if(this.startSectionParagraph&&this.endSectionParagraph){let t=parseInt(this.startSectionParagraph.id),e=parseInt(this.endSectionParagraph.id);if(Number.isNaN(t)||Number.isNaN(e))return[];const i=[];for(let n=t;n<=e;n++){const t=document.getElementById(n+"");t&&i.push($(t))}return i}return this.startSectionParagraph&&!this.endSectionParagraph?[$(this.startSectionParagraph)]:!this.startSectionParagraph&&this.endSectionParagraph?[$(this.endSectionParagraph)]:(console.log("Shouldn't be here"),[])}return[]}handleCopyToCliboardElementCreated(){r.a.loadClipboardCode().then(()=>{const t=new window.Clipboard("#pointing-info-box .copy-to-clipboard",{text:()=>this.pointingLink});t.on("success",t=>a.a.showTemporaryNotification("Link copied to clipboard")),t.on("error",t=>{a.a.showTemporaryNotification("Unfortunatly your environment doesn't support copying to clipboard")})})}}},197:function(t,e,i){"use strict";i.d(e,"a",(function(){return r}));var n=i(2),o=i(0),s=i(4),a=i(3);const r=new class{constructor(){this.loadTextAddonsCodeOnInteraction=this.loadTextAddonsCodeOnInteraction.bind(this)}loadCodeOnInteraction(){s.a.onPassiveEvent(document.querySelectorAll(".book-element-additional-commands-notebook-item"),["mouseenter","touchstart","click"],this.loadTextAddonsCodeOnInteraction)}initialize(t,e){this.getTextAddonsMenuSource().then(({TextAddonsMenu:i})=>i.initialize(t,e)),this.getNotesManagerSource().then(({NotesManager:i})=>i.initialize(t,e))}clean(){this.textAddonsMenuSourcePromise&&this.textAddonsMenuSourcePromise.then(({TextAddonsMenu:t})=>t.clean())}requestOpen(){this.getTextAddonsMenuSource().then(({TextAddonsMenu:t})=>t.open())}cleanNotes(){this.notesManagerSourcePromise&&this.notesManagerSourcePromise.then(({NotesManager:t})=>t.clean())}annotate(t,e,i){this.getNotesManagerSource().then(({NotesManager:n})=>n.annotate(t,e,i))}addNote(t,e,i){this.getNotesManagerSource().then(({NotesManager:n})=>n.addNote(t,e,i))}openNotes(t,e){this.getNotesManagerSource().then(({NotesManager:i})=>i.showNotesBox(t,e))}removeNote(t){this.getNotesManagerSource().then(({NotesManager:e})=>e.removeNote(t))}editNote(t,e){this.getNotesManagerSource().then(({NotesManager:i})=>i.editNote(t,e))}getNoteTextFragment(t){return new Promise((e,i)=>{this.getNotesManagerSource().then(({NotesManager:i})=>{i.getNoteTextFragment(t).then(t=>e(t)).catch(t=>e(null))}).catch(t=>e(null))})}getTextFragmentNotes(t){return new Promise((e,i)=>{this.getNotesManagerSource().then(({NotesManager:i})=>{i.getTextFragmentNotes(t).then(t=>e(t)).catch(t=>e([]))}).catch(t=>e([]))})}loadTextAddonsCodeOnInteraction(t){let e="click"==t.type||o.b.isTouchEventOnTouchDevice(t.type);s.a.offPassiveEvent(document.querySelectorAll(".book-element-additional-commands-notebook-item"),[t.type],this.loadTextAddonsCodeOnInteraction),this.getTextAddonsMenuSource().then(({TextAddonsMenu:i})=>{i.initialize(a.a.book,a.a.bookElement),e&&i.open(),s.a.offPassiveEvent(document.querySelectorAll(".book-element-additional-commands-notebook-item"),e?["mouseenter","touchstart","click"]:[t.type],this.loadTextAddonsCodeOnInteraction)})}getTextAddonsMenuSource(){return this.textAddonsMenuSourcePromise||(n.a.loadMustacheCode(),this.textAddonsMenuSourcePromise=n.a.importWebpackModuleWithRetry(this.constructTextAddonsSourcePromise),s.a.offPassiveEvent(document.querySelectorAll(".book-element-additional-commands-notebook-item"),["mouseenter","touchstart","click"],this.loadTextAddonsCodeOnInteraction)),this.textAddonsMenuSourcePromise}constructTextAddonsSourcePromise(){return Promise.all([i.e(3),i.e(84)]).then(i.bind(null,585))}getNotesManagerSource(){return this.notesManagerSourcePromise||(n.a.loadMustacheCode(),n.a.loadVelocityCode(),this.notesManagerSourcePromise=n.a.importWebpackModuleWithRetry(this.constructNotesManagerSourcePromise)),this.notesManagerSourcePromise}constructNotesManagerSourcePromise(){return Promise.all([i.e(3),i.e(63)]).then(i.bind(null,571))}}},221:function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var n=i(2),o=i(3);const s=new class{constructor(){this.annotateWholeTextFragment=this.annotateWholeTextFragment.bind(this)}initialize(t,e){this.getReviewManagerSource().then(({ReviewManager:t})=>{t.initialize()}),this.getNotesMenuSource().then(({NotesMenu:i})=>i.initialize(t,e)),null!=t&&t.userIsReviewer&&$(".readable-text").on("click",this.annotateWholeTextFragment)}annotate(t,e,i){this.getNotesMenuSource().then(({NotesMenu:n})=>n.annotate(t,e,i))}addReviewItem(t,e,i,n,o,s){return new Promise((a,r)=>{this.getReviewManagerSource().then(({ReviewManager:l})=>{l.addReviewItem(t,e,i,n,o,s).then(t=>a(t)).catch(t=>r(t))}).catch(t=>r(t))})}clean(){this.reviewManagerSourcePromise&&this.reviewManagerSourcePromise.then(({ReviewManager:t})=>t.clean())}getReviewManagerSource(){return this.reviewManagerSourcePromise||(this.reviewManagerSourcePromise=n.a.importWebpackModuleWithRetry(this.constructSourcePromise)),this.reviewManagerSourcePromise}constructSourcePromise(){return Promise.all([i.e(0),i.e(5),i.e(11),i.e(15),i.e(71)]).then(i.bind(null,579))}getNotesMenuSource(){return this.notesMenuSourcePromise||(n.a.loadMustacheCode(),n.a.loadVelocityCode(),this.notesMenuSourcePromise=n.a.importWebpackModuleWithRetry(this.constructNotesMenuSourcePromise)),this.notesMenuSourcePromise}constructNotesMenuSourcePromise(){return i.e(62).then(i.bind(null,317))}annotateWholeTextFragment(t){let e=$(t.currentTarget);e.is("h4, h5, img")&&(e=e.closest(".browsable-container"));const i=$(t.target);if(!i.is("a")&&!(i.is(".text-marginalia-container")||i.closest(".text-marginalia-container").length>0||i.is(".highlighted-comment-text")||i.closest(".highlighted-comment-text").length>0)&&!window.getSelection().toString().trim()&&o.a.bookElement&&o.a.bookElement.reviewVersion>0&&o.a.book&&o.a.book.userIsReviewer){let t="";e.is(".readable-text")?t=e.text():e.is(".browsable-container")&&(t=e.find("h1, h2, h3, h4, h5").text()),t&&this.getPointingSelectionSource().then(({PointingSelection:i})=>{i.isSelectingParagraphs()||this.annotate(e.get(0),t,0)}).catch(i=>{this.annotate(e.get(0),t,0)})}}getPointingSelectionSource(){return this.pointingSelectionPromise||(this.pointingSelectionPromise=n.a.importWebpackModuleWithRetry(this.constructPointingSelectionSourcePromise)),this.pointingSelectionPromise}constructPointingSelectionSourcePromise(){return i.e(65).then(i.bind(null,188))}}},222:function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var n=i(2),o=i(3);const s=new class{initialize(){this.getTermCleanerSource().then(({TermCleanerManager:t})=>{t.initalize(o.a.book.shortName,o.a.bookElement.shortName,o.a.bookElement.meapVersion)})}clean(){this.sourcePromise&&this.getTermCleanerSource().then(({TermCleanerManager:t})=>{t.clean()})}requestTermCreation(t,e,i){this.getTermCleanerSource().then(({TermCleanerManager:n})=>n.requestTermCreation(t,e,i))}getTermCleanerSource(){return this.sourcePromise||(this.sourcePromise=n.a.importWebpackModuleWithRetry(this.constructSourcePromise)),this.sourcePromise}constructSourcePromise(){return Promise.all([i.e(0),i.e(80)]).then(i.bind(null,581))}}},231:function(t,e,i){"use strict";i.d(e,"a",(function(){return T}));var n=i(133),o=i(145),s=i(15),a=i(21),r=i(11),l=i(4),h=i(141),c=i(6),g=i(0),d=i(3);const u=$(document),p="highlighted-text",m="highlighted-note-text",f="highlighted-comment-text",S="dummy-highlighted-text",P=/highlight-(\d+)/i,b=/review-(\d+)/i,x=/note-(\d+)/i;const T=new class{constructor(){this.handleHighlightMouseEnter=this.handleHighlightMouseEnter.bind(this),this.handleHighlightMouseLeave=this.handleHighlightMouseLeave.bind(this),this.handleReviewHighlightClick=this.handleReviewHighlightClick.bind(this),this.handleNoteHighlightClick=this.handleNoteHighlightClick.bind(this),u.on(g.b.isCordova()?"touchstart":"click",".delete-highlight-button",()=>this.handleDeleteButtonClick()),u.on(g.b.isCordova()?"touchstart":"click",".highlight-tooltip-container .color-selector",t=>this.handleColorSelectorClick(t)),u.on("click",`.${f}`,this.handleReviewHighlightClick),u.on("click",`.${m}`,this.handleNoteHighlightClick)}initialize(){d.a.book&&c.a.isLoggedIn().then(t=>{t.loggedIn&&d.a.bookElement&&h.a.fetchHighlights(d.a.bookElement).then(t=>{t.bookElementHighlights.forEach(t=>{t.highlightedParagraphs.forEach(e=>{const i=e.hash?$(`[data-hash=${e.hash}]`):$(document.getElementById(e.ordinal));i.length&&this.highlight(i,e.selectedText,p,t.color,t.id,t.offset)})})})})}clean(){}createHighlightSelection(t,e,i=-1){if(!(t&&t.length&&e&&d.a.bookElement))return;const n=this.getAssociatedReadableTextFragmentAndSelectedText(t,e);if(n&&n.length&&d.a.bookElement&&d.a.bookElement.shortName&&d.a.bookElement.book&&d.a.bookElement.book.shortName){h.a.addHighlight(d.a.bookElement,n.map(t=>new o.a(t.$readableTextFragment.attr("id"),t.$readableTextFragment.attr("data-hash"),t.selectedText)),s.a.getHighlightColor(),i).then(t=>{this.deleteDummyHighlights();for(const e of n)this.highlight(e.$readableTextFragment,e.selectedText,p,s.a.getHighlightColor(),t,i);u.trigger("highlightAdded")}).catch(t=>{this.deleteDummyHighlights(),a.a.showTemporaryNotification("Error when saving highlight!")});for(let t=0;t<n.length;t++){const e=n[t];this.highlight(e.$readableTextFragment,e.selectedText,S,s.a.getHighlightColor(),"",0==t?i:-1)}}}getAssociatedReadableTextFragmentAndSelectedText(t,e){const i=t.filter(t=>t.is(".readable-text")),n=(e||"").split(/(\r)?\n/).filter(t=>""!=t),o=[];for(let t=0,e=0;t<i.length&&e<n.length;){const s=i[t];let a=n[e];-1!=s.text().indexOf(a)?(o.push({$readableTextFragment:s,selectedText:a}),t++,e++):e++}return o}highlightNoteSelection(t,e,i="",n){this.highlight(t,e,m,"",i,n,!1,!0)}highlightReviewSelection(t,e,i,n){this.highlight(t,e,f,"",i,n,!0)}deleteReviewSelectionHighlights(){r.a.unwrapIntoParent($(`.${f}`))}deleteReviewHighlight(t){r.a.unwrapIntoParent($(`.${f}.review-${t}`))}deleteNoteHighlight(t){r.a.unwrapIntoParent($(`.${m}.note-${t}`))}highlight(t,e,i,o,s="",a=-1,r=!1,l=!1){if(!t||!e)return;const h=t.get(0),c=i+(s?` ${r?"review":l?"note":"highlight"}-${s}`:"")+(o?` highlight-color-${o}`:"");if(n.a.highlight(h,e,c,"",a>0?h.textContent.substring(0,a):""),i!=S){this.storeHighlightToOriginalHTML(h,e,c);const n=t.find(`.${i}`);r||l||(g.b.isCordova()?n.on("touchstart",this.handleHighlightMouseEnter):n.hover(this.handleHighlightMouseEnter,this.handleHighlightMouseLeave))}}deleteCurrentNoteHighlight(){r.a.unwrapIntoParent($(`.${m}`))}deleteDummyHighlights(){r.a.unwrapIntoParent($(`.${S}`))}storeHighlightToOriginalHTML(t,e,i){if(!t)return;const o=$("<div>"+t.originalInnerHTML+"</div>");n.a.highlight(o.get(0),e,i),t.originalInnerHTML=o.get(0).innerHTML}handleReviewHighlightClick(t){const e=$(t.target),i=r.a.getClassNameMatchingRegEx(e[0],b).replace("review-","");$(document).trigger("showReviewComment",[i,e.closest(".readable-text").attr("data-hash")])}handleNoteHighlightClick(t){const e=$(t.target),i=r.a.getClassNameMatchingRegEx(e[0],x).replace("note-","");$(document).trigger("noteOpenRequested",[i,e.closest(".readable-text").attr("data-hash")])}handleHighlightMouseEnter(t){const e=$(t.target);clearTimeout(this.mouseLeaveTimer),clearTimeout(this.mouseEnterTimer),this.mouseEnterTimer=l.a.setTimeout(()=>{(r.a.isHover(e)||g.b.isCordova())&&(this.openHighlightTooltip(e),this.selectHeighlight(e),this.$currentlySelectedHighlight=e)},100)}handleHighlightMouseLeave(t){clearTimeout(this.mouseLeaveTimer),this.mouseLeaveTimer=l.a.setTimeout(()=>{this.isMouseOverTooltip()||r.a.isHover($(t.target))?this.handleHighlightMouseLeave(t):(clearTimeout(this.mouseLeaveTimer),this.unselectHighlights(),this.closeHighlightTooltip())},500)}openHighlightTooltip(t){if(this.$currentlySelectedHighlight&&t&&this.$currentlySelectedHighlight[0]==t[0])return;const e=t[0].getBoundingClientRect();r.a.showTooltipAtAbsolutePosition({top:e.bottom+u.scrollTop()+10,left:e.left+e.width/2-130},this.getHighlightMenuHTML());const i=$("#tooltip");t.is(".highlight-color-yellow")?i.find(".color-selector.yellow").addClass("selected"):t.is(".highlight-color-red")?i.find(".color-selector.red").addClass("selected"):t.is(".highlight-color-green")?i.find(".color-selector.green").addClass("selected"):t.is(".highlight-color-blue")?i.find(".color-selector.blue").addClass("selected"):t.is(".highlight-color-pink")&&i.find(".color-selector.pink").addClass("selected"),u.trigger("tooltipOpened")}closeHighlightTooltip(){r.a.hideTooltip(),u.trigger("tooltipClosed"),this.$currentlySelectedHighlight=null}selectHeighlight(t){if(!t||!t.length)return;this.unselectHighlights();const e=r.a.getClassNameMatchingRegEx(t[0],P);e&&$(`.${e}`).addClass("selected-highlight")}unselectHighlights(){$(".selected-highlight").removeClass("selected-highlight")}isMouseOverTooltip(){return r.a.isHover($("#tooltip"))}handleDeleteButtonClick(){if(!this.$currentlySelectedHighlight)return;const t=this.getCurrentlySelectedHighlightClassAndId();null!=t&&this.deleteHighlight(t.classId,t.id)}deleteHighlight(t,e){h.a.removeHighlight(d.a.bookElement,e).catch(()=>a.a.showTemporaryNotification("Error syncing highlight with server.")),this.unselectHighlights(),this.closeHighlightTooltip(),r.a.unwrapIntoParent($(`.${t}`))}handleColorSelectorClick(t){if(!this.$currentlySelectedHighlight)return;const e=$(t.currentTarget);let i=s.a.getHighlightColor();e.is(".red")?i="red":e.is(".green")?i="green":e.is(".yellow")?i="yellow":e.is(".blue")?i="blue":e.is(".pink")&&(i="pink");const n=this.getCurrentlySelectedHighlightClassAndId();null!=n&&this.changeHighlightColor(n.classId,n.id,i)}changeHighlightColor(t,e,i){const n=$(`.${t}`),o=n.attr("class");h.a.changeHighlightColor(d.a.bookElement,e,i).catch(()=>{n.attr("class",o),a.a.showTemporaryNotification("Error syncing highlight with server.")}),n.removeClass("highlight-color-green highlight-color-yellow highlight-color-red highlight-color-pink highlight-color-blue").addClass(`highlight-color-${i}`),s.a.setHighlightColor(i),this.closeHighlightTooltip()}getCurrentlySelectedHighlightClassAndId(){const t=r.a.getClassNameMatchingRegEx(this.$currentlySelectedHighlight[0],P);if(!t)return null;const e=t.match(P);return e&&e[1]?{classId:t,id:+e[1]}:null}getHighlightMenuHTML(){return"<div class='highlight-tooltip-container'><i class='color-selector yellow fal fa-highlighter'></i><i class='color-selector green fal fa-highlighter'></i><i class='color-selector red fal fa-highlighter'></i><i class='color-selector pink fal fa-highlighter'></i><i class='color-selector blue fal fa-highlighter'></i> | <i class='fal fa-trash delete-highlight-button' aria-hidden='true' title='delete highlight'></i></div>"}}},319:function(t,e,i){var n=i(88),o=i(320);"string"==typeof(o=o.__esModule?o.default:o)&&(o=[[t.i,o,""]]);var s={insert:"head",singleton:!1};n(o,s);t.exports=o.locals||{}},320:function(t,e,i){(e=i(89)(!1)).push([t.i,"#pointing-info-box{display:none;width:310px;position:fixed;background-color:gray;bottom:46px;left:50%;transform:translateX(-50%);border-radius:3px;z-index:95;background-color:#fff;border:solid 1px #666;font-size:14px;transition:transform 0.2s ease-in-out}#pointing-info-box:not(.shown){transform:translate(-50%, 150%)}#pointing-info-box.shown{transform:translate(-50%, 0)}#pointing-info-box .fa,#pointing-info-box .fal,#pointing-info-box .fas,#pointing-info-box .far,#pointing-info-box .add-to-cart-button{user-select:none;-webkit-user-select:none;-moz-user-select:moz-none;-ms-user-select:none}#pointing-info-box input{height:37px;display:inline-block}#pointing-info-box .pointing-info-right-container,#pointing-info-box .pointing-info-left-container{font-size:20px;display:inline-block;cursor:pointer;margin:5px 0;width:40px;height:35px;text-align:center}#pointing-info-box .pointing-info-right-container{float:right;color:gray}#pointing-info-box .pointing-info-left-container{float:left}#pointing-info-box .pointing-info-middle-container{line-height:35px;height:35px;padding:3px 0;display:inline-block;width:220px;text-align:center}#pointing-info-box .pointing-info-middle-container a{display:inline-block;width:100%}\n",""]),t.exports=e}}]);
//# sourceMappingURL=textSelectionModule.chunk.js.map?f7b6b01216a7a3b06f22