(window.webpackJsonp=window.webpackJsonp||[]).push([[63,62],{133:function(e,t,n){"use strict";var o=n(8),i=n(11);t.a=new class{highlight(e,t,n,s="",a="",l={}){if(!e)return;const r=$(e);r.is(".fragment-played")&&(s="");const h=i.a.getAllDescendantTextNodes(e),c=i.a.createTextNodeTextRanges(h);let d=o.a.getStartIndex(c.value,t,a),g=d+t.length;if(-1===d&&(g=(d=c.value.indexOf(t.replace("<","&lt;").replace(">","&gt;")))+t.length,-1==d))return;const u=i.a.splitRanges(c,d,g);if(this.markVisibleParentNodeElements(e,u.followingRanges,s),this.liftWordsInMatchingRanges(u.matchingRanges,d,g,n,s,l),this.liftWordsInFollowingRanges(u.followingRanges,s),""!=s.trim()){const e="."+s.trim().replace(/\s+/,".");r.find(e).each((function(e,t){const n=$(t.nextSibling);n.is("img")&&n.addClass(s)}))}}liftWordsInMatchingRanges(e,t,n,o,s,a){for(let l=0,r=e.length;l<r;l++){const h=e[l],c=h.textNode.nodeValue;if(0==l){const e=t-h.start,l=n-h.start,r=c.substring(0,e),d=c.substring(e,l),g=c.substring(l,h.end);$(h.textNode).replaceWith(r+i.a.wrapToHtmlElement("span",Object.assign({class:o},a),d)+(""!=g&&""!=s?i.a.wrapToHtmlElement("span",{class:s},g):g))}else if(l==r-1){const e=n-h.start,t=c.substring(0,e),l=c.substring(e,c.length);$(h.textNode).replaceWith(i.a.wrapToHtmlElement("span",Object.assign({class:o},a),t)+(""!=l&&""!=s?i.a.wrapToHtmlElement("span",{class:s},l):l))}else $(h.textNode).replaceWith(i.a.wrapToHtmlElement("span",Object.assign({class:o},a),c))}}liftWordsInFollowingRanges(e,t){if(t)for(let n=0;n<e.length;n++){const o=e[n];o.textNode.nodeValue&&o.textNode.nodeValue.trim()&&$(o.textNode).replaceWith(i.a.wrapToHtmlElement("span",{class:t},o.textNode.nodeValue))}}markVisibleParentNodeElements(e,t,n){if(e&&t&&0!=t.length&&n)for(let e=0;e<t.length;e++){const o=t[e].textNode;"KBD"==o.parentNode.nodeName&&$(o.parentNode).addClass(n)}}}},221:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var o=n(2),i=n(3);const s=new class{constructor(){this.annotateWholeTextFragment=this.annotateWholeTextFragment.bind(this)}initialize(e,t){this.getReviewManagerSource().then(({ReviewManager:e})=>{e.initialize()}),this.getNotesMenuSource().then(({NotesMenu:n})=>n.initialize(e,t)),null!=e&&e.userIsReviewer&&$(".readable-text").on("click",this.annotateWholeTextFragment)}annotate(e,t,n){this.getNotesMenuSource().then(({NotesMenu:o})=>o.annotate(e,t,n))}addReviewItem(e,t,n,o,i,s){return new Promise((a,l)=>{this.getReviewManagerSource().then(({ReviewManager:r})=>{r.addReviewItem(e,t,n,o,i,s).then(e=>a(e)).catch(e=>l(e))}).catch(e=>l(e))})}clean(){this.reviewManagerSourcePromise&&this.reviewManagerSourcePromise.then(({ReviewManager:e})=>e.clean())}getReviewManagerSource(){return this.reviewManagerSourcePromise||(this.reviewManagerSourcePromise=o.a.importWebpackModuleWithRetry(this.constructSourcePromise)),this.reviewManagerSourcePromise}constructSourcePromise(){return Promise.all([n.e(0),n.e(5),n.e(11),n.e(15),n.e(71)]).then(n.bind(null,579))}getNotesMenuSource(){return this.notesMenuSourcePromise||(o.a.loadMustacheCode(),o.a.loadVelocityCode(),this.notesMenuSourcePromise=o.a.importWebpackModuleWithRetry(this.constructNotesMenuSourcePromise)),this.notesMenuSourcePromise}constructNotesMenuSourcePromise(){return n.e(62).then(n.bind(null,317))}annotateWholeTextFragment(e){let t=$(e.currentTarget);t.is("h4, h5, img")&&(t=t.closest(".browsable-container"));const n=$(e.target);if(!n.is("a")&&!(n.is(".text-marginalia-container")||n.closest(".text-marginalia-container").length>0||n.is(".highlighted-comment-text")||n.closest(".highlighted-comment-text").length>0)&&!window.getSelection().toString().trim()&&i.a.bookElement&&i.a.bookElement.reviewVersion>0&&i.a.book&&i.a.book.userIsReviewer){let e="";t.is(".readable-text")?e=t.text():t.is(".browsable-container")&&(e=t.find("h1, h2, h3, h4, h5").text()),e&&this.getPointingSelectionSource().then(({PointingSelection:n})=>{n.isSelectingParagraphs()||this.annotate(t.get(0),e,0)}).catch(n=>{this.annotate(t.get(0),e,0)})}}getPointingSelectionSource(){return this.pointingSelectionPromise||(this.pointingSelectionPromise=o.a.importWebpackModuleWithRetry(this.constructPointingSelectionSourcePromise)),this.pointingSelectionPromise}constructPointingSelectionSourcePromise(){return n.e(65).then(n.bind(null,188))}}},231:function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));var o=n(133),i=n(145),s=n(15),a=n(21),l=n(11),r=n(4),h=n(141),c=n(6),d=n(0),g=n(3);const u=$(document),m="highlighted-text",p="highlighted-note-text",f="highlighted-comment-text",x="dummy-highlighted-text",b=/highlight-(\d+)/i,N=/review-(\d+)/i,v=/note-(\d+)/i;const w=new class{constructor(){this.handleHighlightMouseEnter=this.handleHighlightMouseEnter.bind(this),this.handleHighlightMouseLeave=this.handleHighlightMouseLeave.bind(this),this.handleReviewHighlightClick=this.handleReviewHighlightClick.bind(this),this.handleNoteHighlightClick=this.handleNoteHighlightClick.bind(this),u.on(d.b.isCordova()?"touchstart":"click",".delete-highlight-button",()=>this.handleDeleteButtonClick()),u.on(d.b.isCordova()?"touchstart":"click",".highlight-tooltip-container .color-selector",e=>this.handleColorSelectorClick(e)),u.on("click",`.${f}`,this.handleReviewHighlightClick),u.on("click",`.${p}`,this.handleNoteHighlightClick)}initialize(){g.a.book&&c.a.isLoggedIn().then(e=>{e.loggedIn&&g.a.bookElement&&h.a.fetchHighlights(g.a.bookElement).then(e=>{e.bookElementHighlights.forEach(e=>{e.highlightedParagraphs.forEach(t=>{const n=t.hash?$(`[data-hash=${t.hash}]`):$(document.getElementById(t.ordinal));n.length&&this.highlight(n,t.selectedText,m,e.color,e.id,e.offset)})})})})}clean(){}createHighlightSelection(e,t,n=-1){if(!(e&&e.length&&t&&g.a.bookElement))return;const o=this.getAssociatedReadableTextFragmentAndSelectedText(e,t);if(o&&o.length&&g.a.bookElement&&g.a.bookElement.shortName&&g.a.bookElement.book&&g.a.bookElement.book.shortName){h.a.addHighlight(g.a.bookElement,o.map(e=>new i.a(e.$readableTextFragment.attr("id"),e.$readableTextFragment.attr("data-hash"),e.selectedText)),s.a.getHighlightColor(),n).then(e=>{this.deleteDummyHighlights();for(const t of o)this.highlight(t.$readableTextFragment,t.selectedText,m,s.a.getHighlightColor(),e,n);u.trigger("highlightAdded")}).catch(e=>{this.deleteDummyHighlights(),a.a.showTemporaryNotification("Error when saving highlight!")});for(let e=0;e<o.length;e++){const t=o[e];this.highlight(t.$readableTextFragment,t.selectedText,x,s.a.getHighlightColor(),"",0==e?n:-1)}}}getAssociatedReadableTextFragmentAndSelectedText(e,t){const n=e.filter(e=>e.is(".readable-text")),o=(t||"").split(/(\r)?\n/).filter(e=>""!=e),i=[];for(let e=0,t=0;e<n.length&&t<o.length;){const s=n[e];let a=o[t];-1!=s.text().indexOf(a)?(i.push({$readableTextFragment:s,selectedText:a}),e++,t++):t++}return i}highlightNoteSelection(e,t,n="",o){this.highlight(e,t,p,"",n,o,!1,!0)}highlightReviewSelection(e,t,n,o){this.highlight(e,t,f,"",n,o,!0)}deleteReviewSelectionHighlights(){l.a.unwrapIntoParent($(`.${f}`))}deleteReviewHighlight(e){l.a.unwrapIntoParent($(`.${f}.review-${e}`))}deleteNoteHighlight(e){l.a.unwrapIntoParent($(`.${p}.note-${e}`))}highlight(e,t,n,i,s="",a=-1,l=!1,r=!1){if(!e||!t)return;const h=e.get(0),c=n+(s?` ${l?"review":r?"note":"highlight"}-${s}`:"")+(i?` highlight-color-${i}`:"");if(o.a.highlight(h,t,c,"",a>0?h.textContent.substring(0,a):""),n!=x){this.storeHighlightToOriginalHTML(h,t,c);const o=e.find(`.${n}`);l||r||(d.b.isCordova()?o.on("touchstart",this.handleHighlightMouseEnter):o.hover(this.handleHighlightMouseEnter,this.handleHighlightMouseLeave))}}deleteCurrentNoteHighlight(){l.a.unwrapIntoParent($(`.${p}`))}deleteDummyHighlights(){l.a.unwrapIntoParent($(`.${x}`))}storeHighlightToOriginalHTML(e,t,n){if(!e)return;const i=$("<div>"+e.originalInnerHTML+"</div>");o.a.highlight(i.get(0),t,n),e.originalInnerHTML=i.get(0).innerHTML}handleReviewHighlightClick(e){const t=$(e.target),n=l.a.getClassNameMatchingRegEx(t[0],N).replace("review-","");$(document).trigger("showReviewComment",[n,t.closest(".readable-text").attr("data-hash")])}handleNoteHighlightClick(e){const t=$(e.target),n=l.a.getClassNameMatchingRegEx(t[0],v).replace("note-","");$(document).trigger("noteOpenRequested",[n,t.closest(".readable-text").attr("data-hash")])}handleHighlightMouseEnter(e){const t=$(e.target);clearTimeout(this.mouseLeaveTimer),clearTimeout(this.mouseEnterTimer),this.mouseEnterTimer=r.a.setTimeout(()=>{(l.a.isHover(t)||d.b.isCordova())&&(this.openHighlightTooltip(t),this.selectHeighlight(t),this.$currentlySelectedHighlight=t)},100)}handleHighlightMouseLeave(e){clearTimeout(this.mouseLeaveTimer),this.mouseLeaveTimer=r.a.setTimeout(()=>{this.isMouseOverTooltip()||l.a.isHover($(e.target))?this.handleHighlightMouseLeave(e):(clearTimeout(this.mouseLeaveTimer),this.unselectHighlights(),this.closeHighlightTooltip())},500)}openHighlightTooltip(e){if(this.$currentlySelectedHighlight&&e&&this.$currentlySelectedHighlight[0]==e[0])return;const t=e[0].getBoundingClientRect();l.a.showTooltipAtAbsolutePosition({top:t.bottom+u.scrollTop()+10,left:t.left+t.width/2-130},this.getHighlightMenuHTML());const n=$("#tooltip");e.is(".highlight-color-yellow")?n.find(".color-selector.yellow").addClass("selected"):e.is(".highlight-color-red")?n.find(".color-selector.red").addClass("selected"):e.is(".highlight-color-green")?n.find(".color-selector.green").addClass("selected"):e.is(".highlight-color-blue")?n.find(".color-selector.blue").addClass("selected"):e.is(".highlight-color-pink")&&n.find(".color-selector.pink").addClass("selected"),u.trigger("tooltipOpened")}closeHighlightTooltip(){l.a.hideTooltip(),u.trigger("tooltipClosed"),this.$currentlySelectedHighlight=null}selectHeighlight(e){if(!e||!e.length)return;this.unselectHighlights();const t=l.a.getClassNameMatchingRegEx(e[0],b);t&&$(`.${t}`).addClass("selected-highlight")}unselectHighlights(){$(".selected-highlight").removeClass("selected-highlight")}isMouseOverTooltip(){return l.a.isHover($("#tooltip"))}handleDeleteButtonClick(){if(!this.$currentlySelectedHighlight)return;const e=this.getCurrentlySelectedHighlightClassAndId();null!=e&&this.deleteHighlight(e.classId,e.id)}deleteHighlight(e,t){h.a.removeHighlight(g.a.bookElement,t).catch(()=>a.a.showTemporaryNotification("Error syncing highlight with server.")),this.unselectHighlights(),this.closeHighlightTooltip(),l.a.unwrapIntoParent($(`.${e}`))}handleColorSelectorClick(e){if(!this.$currentlySelectedHighlight)return;const t=$(e.currentTarget);let n=s.a.getHighlightColor();t.is(".red")?n="red":t.is(".green")?n="green":t.is(".yellow")?n="yellow":t.is(".blue")?n="blue":t.is(".pink")&&(n="pink");const o=this.getCurrentlySelectedHighlightClassAndId();null!=o&&this.changeHighlightColor(o.classId,o.id,n)}changeHighlightColor(e,t,n){const o=$(`.${e}`),i=o.attr("class");h.a.changeHighlightColor(g.a.bookElement,t,n).catch(()=>{o.attr("class",i),a.a.showTemporaryNotification("Error syncing highlight with server.")}),o.removeClass("highlight-color-green highlight-color-yellow highlight-color-red highlight-color-pink highlight-color-blue").addClass(`highlight-color-${n}`),s.a.setHighlightColor(n),this.closeHighlightTooltip()}getCurrentlySelectedHighlightClassAndId(){const e=l.a.getClassNameMatchingRegEx(this.$currentlySelectedHighlight[0],b);if(!e)return null;const t=e.match(b);return t&&t[1]?{classId:e,id:+t[1]}:null}getHighlightMenuHTML(){return"<div class='highlight-tooltip-container'><i class='color-selector yellow fal fa-highlighter'></i><i class='color-selector green fal fa-highlighter'></i><i class='color-selector red fal fa-highlighter'></i><i class='color-selector pink fal fa-highlighter'></i><i class='color-selector blue fal fa-highlighter'></i> | <i class='fal fa-trash delete-highlight-button' aria-hidden='true' title='delete highlight'></i></div>"}}},317:function(e,t,n){"use strict";n.r(t),n.d(t,"NotesMenu",(function(){return u}));var o=n(4),i=n(21),s=n(13),a=n(141),l=n(6),r=(n(573),n(221)),h=n(318),c=n(197);const d=$(window),g=$(document);const u=new class{constructor(){this.handleEditNoteClickTouch=this.handleEditNoteClickTouch.bind(this),this.handleDeleteNoteClickTouch=this.handleDeleteNoteClickTouch.bind(this),this.handleSaveNoteClickTouch=this.handleSaveNoteClickTouch.bind(this),this.handleCloseNoteClickTouch=this.handleCloseNoteClickTouch.bind(this),this.handleNoteDblClick=this.handleNoteDblClick.bind(this),this.handleNoteMouseEnter=this.handleNoteMouseEnter.bind(this),this.handleNoteMouseLeave=this.handleNoteMouseLeave.bind(this),this.handleOpenNoteRequested=this.handleOpenNoteRequested.bind(this),this.handleCloseMenuEvent=this.handleCloseMenuEvent.bind(this),this.handleAddNoteButtonClick=this.handleAddNoteButtonClick.bind(this),this.handleNoteInputBoxKeyDown=this.handleNoteInputBoxKeyDown.bind(this),this.handleParagraphOpenNoteRequested=this.handleParagraphOpenNoteRequested.bind(this),this.closeNotesBox=this.closeNotesBox.bind(this),this.handleNoteCloseRequested=this.handleNoteCloseRequested.bind(this),$(document.body).append(this.getNotesMenuHTML()),$(document).on("textSlideMenuBeginOpening",()=>{h.a.immediatelyClose(this.$notesMenu)})}initialize(e,t){this.clean(),e&&l.a.isCurrentlyLoggedIn()&&(this.book=e,this.bookElement=t,this.isInReviewMode=this.bookElement.reviewVersion>0,this.$notesMenu=$("#notes-menu"),this.$notesList=this.$notesMenu.find(".notes-list"),this.$noteInputBox=$("#note-input-box"),this.$addNoteButton=$("#add-note-button"),o.a.onDescendantEventWithCooldown(this.$notesMenu,"click touchstart",".note-edit-icon",this.handleEditNoteClickTouch),o.a.onDescendantEventWithCooldown(this.$notesMenu,"click touchstart",".note-delete-icon",this.handleDeleteNoteClickTouch),o.a.onDescendantEventWithCooldown(this.$notesMenu,"click touchstart",".note-input-save",this.handleSaveNoteClickTouch),o.a.onDescendantEventWithCooldown(this.$notesMenu,"click touchstart",".note-close-icon, .note-input-cancel",this.handleCloseNoteClickTouch),o.a.onDescendantEventWithCooldown(this.$notesMenu,"click touchstart",".notes-menu-close",this.handleCloseMenuEvent),this.$notesMenu.on("dblclick",".note-content-container",this.handleNoteDblClick),this.$notesMenu.on("mouseenter",".note-item-container",this.handleNoteMouseEnter),this.$notesMenu.on("mouseleave",this.handleNoteMouseLeave),g.on("noteOpenRequested",this.handleOpenNoteRequested),g.on("paragraphNoteOpenRequested",this.handleParagraphOpenNoteRequested),g.on("noteCloseRequested slideMenuCloseRequested",this.handleNoteCloseRequested),d.on("orientationchange",this.handleCloseMenuEvent),o.a.onEventWithCooldown(this.$addNoteButton,"click touchstart",this.handleAddNoteButtonClick),this.$noteInputBox.on("keydown",this.handleNoteInputBoxKeyDown),this.$notesMenu.find(".notes-menu-heading").text(this.isInReviewMode?"review comments":"notes"),this.$notesMenu.find("#note-input-box").attr("placeholder",this.isInReviewMode?"add a comment (please do not report typos and grammar corrections)":"new note"))}clean(){this.book=null,this.bookElement=null,this.$currentTextFragment=null,this.isInReviewMode=!1}handleNoteInputBoxKeyDown(e){(e.ctrlKey||e.metaKey)&&13==e.keyCode?this.addNote(this.$noteInputBox.val().trim()):27==e.which&&this.closeNotesBox()}handleAddNoteButtonClick(){this.addNote(this.$noteInputBox.val().trim())}handleCloseMenuEvent(){this.closeNotesBox()}handleOpenNoteRequested(e,t){c.a.getNoteTextFragment(t).then(e=>{null!=e&&(this.$currentTextFragment=e,this.showNotesBox(e))})}handleParagraphOpenNoteRequested(e,t){this.$currentTextFragment=$(`[refid='${t}']`),this.showNotesBox(this.$currentTextFragment)}handleNoteDblClick(e){this.handleEnterEditNote(e)}handleEditNoteClickTouch(e){this.handleEnterEditNote(e)}handleDeleteNoteClickTouch(e){this.handleDeleteNoteClick(e)}handleSaveNoteClickTouch(e){this.handleLeaveEditNoteAndSave(e)}handleCloseNoteClickTouch(e){this.handleLeaveEditNoteWithoutSave(e)}addNote(e){if(this.isAddingNoteDisabled)return;if(null!=this.$currentTextFragment&&0!=this.$currentTextFragment.length||(this.$currentTextFragment=$(".readable-text.paragraph-focused")),null==this.$currentTextFragment||0==this.$currentTextFragment.length)return null;if(!(e=(e||"").trim())||e.length<1)return;const t=this.$currentTextFragment.attr("refid"),n=this.$currentTextFragment.attr("data-hash");this.isAddingNoteDisabled=!0,this.$addNoteButton.append("<i class='fa fa-spin fa-circle-notch'/>");const o=t=>{if(this.isAddingNoteDisabled=!1,this.$addNoteButton.find(".fa").remove(),!this.bookElement.reviewVersion){const n=this.createNoteElement(e);n.attr("data-note-id",t),this.$notesList.append(n),c.a.addNote(this.$currentTextFragment,e,t)}this.$noteInputBox.val(""),g.trigger("noteAdded")},s=()=>{this.isAddingNoteDisabled=!1,this.$addNoteButton.find(".fa").remove(),i.a.showTemporaryNotification("Error when trying to store note. Please try later")};this.bookElement.reviewVersion>0?r.a.addReviewItem(e,this.annotatedText,t,n,this.getSectionTitle(this.$currentTextFragment),this.annotatedTextOffset).then(o).catch(s):a.a.addNote(this.bookElement,t,n,this.annotatedText,e,this.getSection(this.$currentTextFragment),this.bookElement.meapVersion,this.bookElement.reviewVersion).then(o).catch(s)}handleEnterEditNote(e){const t=$(e.currentTarget).parents(".note-item-container"),n=t.find(".note-input-container"),o=t.find(".note-content-container");o.is(".note-content-container-can-edit")&&(n.text(o.text()),n.val(o.text()),t.addClass("edit-mode"))}handleDeleteNoteClick(e){const t=$(e.currentTarget).parents(".note-item-container"),n=t.find(".note-content-container"),o=t.attr("data-note-id");n.is(".waiting-for-deletion")||(n.addClass("waiting-for-deletion"),this.removeNote(o,()=>{t.remove(),c.a.removeNote(o)},()=>{n.removeClass("waiting-for-deletion"),i.a.showTemporaryNotification("Error when deleting note, try again later")}))}handleLeaveEditNoteAndSave(e){const t=$(e.currentTarget).parents(".note-item-container"),n=t.find(".note-input-container"),o=t.find(".note-content-container"),i=t.attr("data-note-id");t.removeClass("edit-mode");const s=n.val();o.text(s),a.a.editNote(this.bookElement,parseInt(i),s).then(e=>{c.a.editNote(i,s)})}handleLeaveEditNoteWithoutSave(e){$(e.currentTarget).parents(".note-item-container").removeClass("edit-mode")}renderNotes(e){if(this.$notesList.empty(),e&&e.length)for(let t=0;t<e.length;t++){const n=e[t];if(!n)continue;const o=this.createNoteElement(n.noteText);o.attr("data-note-id",n.id),this.$notesList.append(o)}}createNoteElement(e){return $(`<li class="note-item-container">\n            <div class="note-content-container note-content-container-can-edit">${e}</div>\n            <textarea class="note-input-container">${e}</textarea>\n            <a href="javascript:void(0)" class="note-input-save">Save</a>\n            <a href="javascript:void(0)" class="note-input-cancel">Cancel</a>\n            <i class="fa note-edit-icon fa-pencil"></i><i class="fa note-delete-icon fa-trash"></i><i class="fa note-close-icon fa-times"></i>\n        </li>`)}removeNote(e,t,n){e&&a.a.removeNote(this.bookElement,parseInt(e)).then(e=>e?t():n()).catch(e=>n())}handleNoteMouseEnter(e){const t=$(e.currentTarget).attr("data-note-id");$(".highlighted-note-text.selected").removeClass("selected"),$(`.highlighted-note-text.note-${t}`).addClass("selected")}handleNoteMouseLeave(){$(".highlighted-note-text.selected").removeClass("selected")}annotate(e,t,n){if(!e)return;this.annotatedText=t,this.annotatedTextOffset=n;const o=$(e);null!=this.$currentTextFragment&&this.$currentTextFragment.attr("refid")!=o.attr("refid")?this.closeNotesBox(()=>{this.showNotesBox(o)}):(this.$currentTextFragment=o,this.showNotesBox(o))}showNotesBox(e,t){c.a.getTextFragmentNotes(e).then(n=>{this.renderNotes(n),$(document).trigger("textSlideBoxShowStart"),h.a.show(this.$notesMenu,e,()=>{e.addClass("paragraph-focused"),this.$noteInputBox.focus(),t&&t()})})}handleNoteCloseRequested(){this.closeNotesBox()}closeNotesBox(e){this.$noteInputBox.blur(),h.a.close(this.$notesMenu,e),$(".paragraph-focused").removeClass("paragraph-focused"),this.$currentTextFragment=null}getSectionTitle(e){return s.a.figureOutSectionOrSubsectionTitleFromRefId(e.attr("refid"))||this.bookElement.title}getSection(e){const t=s.a.figureOutSectionOrSubsectionFromRefId(e.attr("refid"));if(t)return t;const n=this.bookElement.shortName.match(/(part\s+\d)|\w+\s+(\d+)/i);if(n){if(n[1])return n[1];if(n[2])return n[2]}return this.book.shortName}getNotesMenuHTML(){return'<div id="notes-menu" class="closed">\n                    <span class="notes-menu-heading">notes</span>\n                    <span class="notes-menu-close"><i class="fal fa-times"/></span>\n                    <ul class="notes-list"></ul>\n                    <textarea id="note-input-box" type="text" placeholder="new note..."></textarea>\n                    <div class="notes-menu-command-container">\n                        <button id="add-note-button">add</button>\n                    </div>\n                </div>'}}},318:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var o=n(9),i=n(4),s=n(39);const a=new class{show(e,t,n){const a=document.getElementById("book-main-content-container"),l=$(a),r=t.offset(),h=t.height(),c=t.width(),d=t.outerWidth(),g=parseFloat(t.css("padding-right")),u=this.getNecessaryBoxFitShift(e,t),m=o.a.getComputedTranslateX(a),p=(t=!1)=>{$(document).trigger("textSlideBoxOpened");const o=this.getMainContainerViewRectangle(),s=this.getViewportRectangle(),l=e.height();let d=r.top,p=d+l,f=!1;p>o.bottom&&(d-=p-o.bottom)<o.top&&(d=o.top);let x=0;t?(x=a.offsetLeft+a.offsetWidth/2-e.width()/2,h>.7*$(window).height()?d+=40:d+=h+10):x=r.left+c+u-m+g+10,p=d+l,d>s.bottom&&p<s.top&&(f=!0),e.css({top:d,left:x});const b=e.is(".open");e.removeClass("closed").addClass("open"),b?n&&n():e.velocity("manning.fromLeftIn",()=>{f?($(document).trigger("requestScrollToElement",[e.get(0)]),n&&i.a.setTimeout(n,1e3)):n&&n()})};0==u||Math.abs(m-u)<.1?p():r.left+(d-c)/2+u<0?s.a.scrollToElement(t[0],()=>{p(!0)}):l.velocity({translateX:u},()=>p())}close(e,t){$(document).trigger("textSlideBoxClosed");const n=$(document.getElementById("book-main-content-container"));$(".paragraph-focused").removeClass("paragraph-focused"),e.velocity("manning.fromLeftOut",{duration:200,complete:()=>{e.removeClass("open").addClass("closed"),n.velocity({translateX:0},{complete:()=>{n.css("transform",""),t&&t()}})}})}immediatelyClose(e){e&&(e.removeClass("open").addClass("closed").css({opacity:0}),$(".paragraph-focused").removeClass("paragraph-focused"))}getNecessaryBoxFitShift(e,t){const n=document.documentElement.clientWidth,i=e.width(),s=t.offset().left,a=o.a.getComputedTranslateX(document.getElementById("book-main-content-container")),l=n-(s+t.width()+i+40+parseFloat(t.css("padding-right")))+a;return l>0?0:l}getMainContainerViewRectangle(){const e=$("#book-markup-container"),t=e.offset();return{top:t.top,bottom:t.top+e.height()}}getViewportRectangle(){return{top:window.pageYOffset,bottom:window.pageYOffset+$(window).height()}}}},571:function(e,t,n){"use strict";n.r(t),n.d(t,"NotesManager",(function(){return r}));var o=n(141),i=n(572),s=n(231),a=n(317),l=n(3);const r=new class{constructor(){}initialize(e,t){o.a.fetchNotes(t).then(n=>{if(this.notesData=n,null!=n&&null!=n.bookElementNotes&&n.bookElementNotes.length>0){i.a.renderNotes(n);for(const e of n.bookElementNotes){const t=this.getAssociatedTextFragment(e);null!=t&&s.a.highlightNoteSelection($(t),e.annotatedText,e.id,0)}}a.NotesMenu.initialize(e,t),l.a.noteTargetParagraph&&a.NotesMenu.showNotesBox($(`[refid='${l.a.noteTargetParagraph}']`))}).catch(n=>{a.NotesMenu.initialize(e,t)})}clean(){this.notesData=null,a.NotesMenu.clean()}annotate(e,t,n){a.NotesMenu.annotate(e,t,n)}addNote(e,t,n){$(".highlighted-note-text.note--1").removeClass("note--1").addClass(`note-${n}`),i.a.appendNote(e,t,n)}showNotesBox(e,t){this.getNoteTextFragment(e).then(e=>a.NotesMenu.showNotesBox(e,t))}getNoteTextFragment(e){return new Promise((t,n)=>{if(null==this.notesData||null==this.notesData.bookElementNotes||0==this.notesData.bookElementNotes.length)return void t(null);const o=this.notesData.bookElementNotes.find(t=>t.id==e);if(null==o)return void t(null);const i=this.getAssociatedTextFragment(o);t(null!=i?$(i):null)})}getTextFragmentNotes(e){return new Promise((t,n)=>{if(null==this.notesData||null==this.notesData.bookElementNotes||0==this.notesData.bookElementNotes.length)return void t([]);const o=this.notesData.bookElementNotes,i=e.attr("data-hash");if(i){const e=o.filter(e=>e.contentHash==i);if(e.length>0)return void t(e)}const s=e.attr("refid");t(o.filter(e=>e.contentID==s))})}removeNote(e){e&&(s.a.deleteNoteHighlight(e),i.a.deleteNote(e))}editNote(e,t){i.a.updateNote(t,e)}getAssociatedTextFragment(e){if(null==e)return null;let t=e.contentHash&&document.querySelector(`[data-hash='${e.contentHash}']`);return t||(t=document.querySelector(`[refid='${e.contentID}']`)),t}}},572:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var o=n(2);const i=new class{initialize(){this.getSource().then(({TextMarginaliaManager:e})=>e.initialize())}renderNotebookItems(e){this.getSource().then(({TextMarginaliaManager:t})=>t.renderNotebookItems(e))}renderNotes(e){this.getSource().then(({TextMarginaliaManager:t})=>t.renderNotes(e))}appendNotebookItem(e){this.getSource().then(({TextMarginaliaManager:t})=>t.appendNotebookItem(e))}appendNote(e,t,n){this.getSource().then(({TextMarginaliaManager:o})=>o.appendNote(e,t,n))}updateNotebookItem(e){this.getSource().then(({TextMarginaliaManager:t})=>t.updateNotebookItem(e))}updateNote(e,t){this.getSource().then(({TextMarginaliaManager:n})=>n.updateNote(e,t))}deleteNotebookItem(e){this.getSource().then(({TextMarginaliaManager:t})=>t.deleteNotebookItem(e))}deleteNote(e){this.getSource().then(({TextMarginaliaManager:t})=>t.deleteNote(e))}getSource(){return this.sourcePromise||(this.sourcePromise=o.a.importWebpackModuleWithRetry(this.constructSourcePromise)),this.sourcePromise}constructSourcePromise(){return n.e(85).then(n.bind(null,684))}}},573:function(e,t,n){var o=n(88),i=n(574);"string"==typeof(i=i.__esModule?i.default:i)&&(i=[[e.i,i,""]]);var s={insert:"head",singleton:!1};o(i,s);e.exports=i.locals||{}},574:function(e,t,n){(t=n(89)(!1)).push([e.i,"#notes-menu{width:280px;position:absolute;top:100px;right:20px;background:white;padding:10px;z-index:96;border-radius:3px;box-shadow:0 5px 10px 0 rgba(0,0,0,0.2)}@media only screen and (min-width: 320px) and (max-width: 689px){#notes-menu{width:350px;max-width:75%}}#notes-menu .notes-menu-close{color:#666;position:absolute;top:0;right:0;padding:10px;cursor:pointer}#notes-menu #add-note-button{margin:0;padding:4px 8px;border-radius:3px;background-color:#407FBF;border:1px solid #2d5986;color:#FFFFFF;font-family:Lato,-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:14px;letter-spacing:0;line-height:17px}#notes-menu #add-note-button:hover{background-color:#3a72ac}#notes-menu #add-note-button:focus{border-color:#264c73;outline:none}#notes-menu #add-note-button:active{background-color:#369}#notes-menu #add-note-button .fa{margin-left:2px}#notes-menu.closed{display:none}#notes-menu.open{display:block}#notes-menu .notes-menu-heading{color:#1E1F20;margin-top:2px;font-size:16px;font-weight:500;user-select:none;-webkit-user-select:none}#notes-menu .note-delete-icon,#notes-menu .note-edit-icon{position:absolute;right:0.2rem;top:0.2rem;color:#666;cursor:pointer;display:none;width:24px;height:24px;text-align:center;cursor:pointer;color:#666;transition:all 0.25s ease-out;border:1px solid #ccc;background:#fff;font-size:16px;padding-top:2px}#notes-menu .note-delete-icon:hover,#notes-menu .note-edit-icon:hover{color:#000}#notes-menu .note-close-icon{display:none !important}#notes-menu .note-delete-icon{border-top-right-radius:3px;border-bottom-right-radius:3px;border-left:0}#notes-menu .note-edit-icon{right:27px;border-top-left-radius:3px;border-bottom-left-radius:3px;border-right:0}#notes-menu .note-item-container{position:relative;padding:10px}#notes-menu .note-item-container .note-item-username-container{font-weight:bold}#notes-menu .note-item-container:not(.edit-mode) .note-input-container{display:none}#notes-menu .note-item-container:not(.edit-mode) .note-content-container{display:block;max-height:200px;overflow:auto}#notes-menu .note-item-container:not(.edit-mode):hover .note-delete-icon,#notes-menu .note-item-container:not(.edit-mode):hover .note-edit-icon{display:block}#notes-menu .note-item-container:not(.edit-mode) .note-input-save,#notes-menu .note-item-container:not(.edit-mode) .note-input-cancel{display:none}#notes-menu .note-item-container.edit-mode .note-input-container{display:block}#notes-menu .note-item-container.edit-mode .note-content-container{display:none}#notes-menu .note-item-container.edit-mode:hover .note-close-icon{display:block}#notes-menu .note-item-container.edit-mode .note-input-save,#notes-menu .note-item-container.edit-mode .note-input-cancel{display:inline-block}#notes-menu .note-item-container:not(:last-child){border-bottom:1px dashed #ccc}#notes-menu .note-item-container:last-child{padding-bottom:0}#notes-menu .note-item-container .waiting-for-deletion{opacity:0.4}#notes-menu .note-input-container{display:none;position:relative}#notes-menu .note-content-container{display:block;color:black;font-size:14px;position:relative;padding:5px}#notes-menu .note-content-container:hover{background-color:#f9f9f9}#notes-menu #note-input-box,#notes-menu .note-input-container{height:100px;border:1px solid rgba(61,62,65,0.05);border-bottom:none;background-color:#f5f5f5;overflow:auto}#notes-menu #note-input-box{margin:10px 0 0 0;font-size:16px;box-shadow:none;border-radius:3px 3px 0 0;border-bottom:none}#notes-menu .notes-menu-command-container{background:#f5f5f5;border-radius:0 0 3px 3px;padding:5px;text-align:right}#notes-menu .note-input-container{margin-bottom:3px}#notes-menu .note-input-save{margin-right:10px}#notes-menu .notes-list{list-style-type:none;font-size:smaller;margin-bottom:5px;margin-left:0;overflow-y:auto;overscroll-behavior-y:none;-webkit-overflow-scrolling:touch;margin-top:5px;max-height:500px;overflow:auto}#notes-menu .notes-list li{padding-left:5px}\n",""]),e.exports=t}}]);
//# sourceMappingURL=notesModule.chunk.js.map?8321d5a8b796bce5f6ea